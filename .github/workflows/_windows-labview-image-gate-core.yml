name: _windows-labview-image-gate-core

on:
  workflow_call:
    outputs:
      gate_status:
        description: Pass/fail status for the Windows image gate.
        value: ${{ jobs.windows-labview-image-gate.outputs.gate_status }}
      gate_report_artifact_name:
        description: Artifact name containing gate logs and reports.
        value: ${{ jobs.windows-labview-image-gate.outputs.gate_report_artifact_name }}
      gate_report_path:
        description: Full path for the generated windows image gate report JSON.
        value: ${{ jobs.windows-labview-image-gate.outputs.gate_report_path }}

permissions:
  contents: read

jobs:
  windows-labview-image-gate:
    name: Windows LabVIEW Image Gate
    runs-on: [self-hosted, windows, self-hosted-windows-lv, windows-containers, user-session, cdev-surface-windows-gate]
    outputs:
      gate_status: ${{ steps.capture-gate-metadata.outputs.gate_status }}
      gate_report_artifact_name: ${{ steps.capture-gate-metadata.outputs.gate_report_artifact_name }}
      gate_report_path: ${{ steps.capture-gate-metadata.outputs.gate_report_path }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build installer payload for gate
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $gateRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate'
          $payloadRoot = Join-Path $gateRoot 'payload'
          if (Test-Path -LiteralPath $gateRoot -PathType Container) {
            Remove-Item -LiteralPath $gateRoot -Recurse -Force
          }
          New-Item -Path $payloadRoot -ItemType Directory -Force | Out-Null
          $payloadContractRoot = Join-Path $env:GITHUB_WORKSPACE 'workspace-governance-payload'
          if (-not (Test-Path -LiteralPath $payloadContractRoot -PathType Container)) {
            throw "Canonical payload root not found: $payloadContractRoot"
          }
          Copy-Item -Path (Join-Path $payloadContractRoot '*') -Destination $payloadRoot -Recurse -Force

          New-Item -Path (Join-Path $payloadRoot 'scripts') -ItemType Directory -Force | Out-Null
          New-Item -Path (Join-Path $payloadRoot 'tools\runner-cli\win-x64') -ItemType Directory -Force | Out-Null

          Copy-Item -Path "$env:GITHUB_WORKSPACE/scripts/Install-WorkspaceFromManifest.ps1" -Destination (Join-Path $payloadRoot 'scripts/Install-WorkspaceFromManifest.ps1') -Force

          & pwsh -NoProfile -File "$env:GITHUB_WORKSPACE/scripts/Build-RunnerCliBundleFromManifest.ps1" `
            -ManifestPath (Join-Path $payloadRoot 'workspace-governance/workspace-governance.json') `
            -OutputRoot (Join-Path $payloadRoot 'tools/runner-cli/win-x64') `
            -RepoName 'labview-icon-editor' `
            -Runtime 'win-x64' `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to build runner-cli bundle for windows image gate."
          }

          $installerPath = Join-Path $gateRoot 'lvie-cdev-workspace-installer.exe'
          $labviewImageForGate = '${{ vars.LABVIEW_WINDOWS_IMAGE }}'
          if ([string]::IsNullOrWhiteSpace($labviewImageForGate)) {
            $labviewImageForGate = 'nationalinstruments/labview:2026q1-windows'
          }

          $requiredLabviewYear = ''
          $requiredLabviewYearOverride = '${{ vars.LABVIEW_GATE_REQUIRED_LABVIEW_YEAR }}'
          if (-not [string]::IsNullOrWhiteSpace($requiredLabviewYearOverride)) {
            $requiredLabviewYear = $requiredLabviewYearOverride
          } else {
            $imageYearMatch = [regex]::Match($labviewImageForGate, '(\d{4})q\d+-windows')
            if ($imageYearMatch.Success) {
              $requiredLabviewYear = [string]$imageYearMatch.Groups[1].Value
            }
          }

          $gateManifestPath = Join-Path $payloadRoot 'workspace-governance\workspace-governance.json'
          if ([string]::IsNullOrWhiteSpace($requiredLabviewYear) -and (Test-Path -LiteralPath $gateManifestPath -PathType Leaf)) {
            try {
              $gateManifest = Get-Content -LiteralPath $gateManifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
              $manifestRequiredYear = [string]$gateManifest.installer_contract.labview_gate.required_year
              if (-not [string]::IsNullOrWhiteSpace($manifestRequiredYear)) {
                $requiredLabviewYear = $manifestRequiredYear
              }
            } catch {
              throw "Unable to parse installer contract required year from '$gateManifestPath'. $($_.Exception.Message)"
            }
          }
          if ([string]::IsNullOrWhiteSpace($requiredLabviewYear)) {
            $requiredLabviewYear = '2020'
          }
          $nsisRoot = '${{ vars.NSIS_ROOT }}'
          if ([string]::IsNullOrWhiteSpace($nsisRoot)) { $nsisRoot = 'C:\Program Files (x86)\NSIS' }
          & pwsh -NoProfile -File "$env:GITHUB_WORKSPACE/scripts/Build-WorkspaceBootstrapInstaller.ps1" `
            -PayloadRoot $payloadRoot `
            -OutputPath $installerPath `
            -WorkspaceRootDefault 'C:\workspace\gate-dev' `
            -RequiredLabviewYear $requiredLabviewYear `
            -NsisRoot $nsisRoot `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to build installer for windows image gate."
          }

      - name: Validate Windows container engine and configure isolation
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $labviewImage = '${{ vars.LABVIEW_WINDOWS_IMAGE }}'
          if ([string]::IsNullOrWhiteSpace($labviewImage)) {
            $labviewImage = 'nationalinstruments/labview:2026q1-windows'
          }
          $requestedIsolation = '${{ vars.LABVIEW_WINDOWS_DOCKER_ISOLATION }}'
          if ([string]::IsNullOrWhiteSpace($requestedIsolation)) {
            $requestedIsolation = 'auto'
          }
          $requestedIsolation = $requestedIsolation.Trim().ToLowerInvariant()
          if (@('auto', 'process', 'hyperv') -notcontains $requestedIsolation) {
            throw "Invalid LABVIEW_WINDOWS_DOCKER_ISOLATION value '$requestedIsolation'. Supported values: auto, process, hyperv."
          }

          $serverOs = (& docker version --format '{{.Server.Os}}' 2>$null).Trim().ToLowerInvariant()
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($serverOs)) {
            throw 'Failed to query Docker server OS. Ensure Docker Desktop is running and accessible from the runner service account.'
          }
          if ($serverOs -ne 'windows') {
            throw "Docker server OS is '$serverOs'. Runner must be preconfigured for Windows containers; automatic engine switching is disabled for non-interactive CI."
          }

          $hostKernelVersion = (& docker version --format '{{.Server.KernelVersion}}' 2>$null).Trim()
          if ([string]::IsNullOrWhiteSpace($hostKernelVersion)) {
            $hostKernelVersion = [System.Environment]::OSVersion.Version.ToString()
          }

          $manifestJson = (& docker manifest inspect --verbose $labviewImage 2>$null)
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($manifestJson)) {
            throw "Failed to inspect Docker image manifest for '$labviewImage'."
          }

          $manifest = $manifestJson | ConvertFrom-Json -ErrorAction Stop
          $imageOsVersion = [string]$manifest.Descriptor.platform.'os.version'
          if ([string]::IsNullOrWhiteSpace($imageOsVersion)) {
            throw "Docker image '$labviewImage' does not expose Descriptor.platform.os.version; cannot validate host compatibility."
          }

          function Get-WindowsVersionPrefix {
            param([Parameter(Mandatory = $true)][string]$VersionString)
            if ($VersionString -match '(\d+\.\d+\.\d+)') {
              return $Matches[1]
            }
            return $VersionString
          }

          $hostVersionPrefix = Get-WindowsVersionPrefix -VersionString $hostKernelVersion
          $imageVersionPrefix = Get-WindowsVersionPrefix -VersionString $imageOsVersion

          $effectiveIsolation = 'process'
          if ($hostVersionPrefix -ne $imageVersionPrefix) {
            if ($requestedIsolation -eq 'process') {
              throw "Windows container compatibility mismatch. Host kernel '$hostKernelVersion' does not match image '$labviewImage' os.version '$imageOsVersion'. LABVIEW_WINDOWS_DOCKER_ISOLATION is explicitly set to process, so fallback is disabled."
            }
            $effectiveIsolation = 'hyperv'
            Write-Host "::warning::Windows container compatibility mismatch detected. Falling back to Hyper-V isolation for image '$labviewImage'. Host='$hostKernelVersion' Image='$imageOsVersion'."
          } elseif ($requestedIsolation -eq 'hyperv') {
            $effectiveIsolation = 'hyperv'
            Write-Host "::notice::LABVIEW_WINDOWS_DOCKER_ISOLATION requests Hyper-V isolation for compatible host/image versions."
          }

          if ($effectiveIsolation -eq 'process') {
            docker pull $labviewImage
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to pull LabVIEW Windows image '$labviewImage'."
            }
          } else {
            Write-Host "Skipping explicit docker pull because effective isolation is '$effectiveIsolation'. The docker run step will resolve and pull image '$labviewImage' under Hyper-V isolation."
          }

          "LABVIEW_WINDOWS_IMAGE=$labviewImage" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "LABVIEW_WINDOWS_DOCKER_ISOLATION=$effectiveIsolation" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Run installer and runner-cli gate in Windows container
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $gateRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate'
          $installerPath = Join-Path $gateRoot 'lvie-cdev-workspace-installer.exe'
          if (-not (Test-Path -LiteralPath $installerPath -PathType Leaf)) {
            throw "Installer missing for gate: $installerPath"
          }

          $containerCmd = @'
          $ErrorActionPreference = "Stop"

          $env:Path = @(
            'C:\host-tools\PowerShell7',
            'C:\host-tools\Git\cmd',
            'C:\host-tools\GitHubCLI',
            'C:\host-tools\G-CLI\bin',
            $env:Path
          ) -join ';'
          $env:VIPM_COMMUNITY_EDITION = 'true'
          $env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD = [string]$env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD
          $env:LVIE_GATE_REQUIRED_LABVIEW_YEAR = [string]$env:LVIE_GATE_REQUIRED_LABVIEW_YEAR
          $env:LVIE_GATE_SINGLE_PPL_BITNESS = [string]$env:LVIE_GATE_SINGLE_PPL_BITNESS

          $requiredCommands = @('powershell', 'pwsh', 'git', 'gh')
          $missingCommands = @()
          foreach ($name in $requiredCommands) {
            if (-not (Get-Command $name -ErrorAction SilentlyContinue)) {
              $missingCommands += $name
            }
          }
          if ($missingCommands.Count -gt 0) {
            throw "Container runtime missing required commands after host-tool mount: $($missingCommands -join ', ')"
          }

          $installerProcess = Start-Process `
            -FilePath "C:\workspace\artifacts\windows-image-gate\lvie-cdev-workspace-installer.exe" `
            -ArgumentList '/S' `
            -Wait `
            -PassThru
          $launchLogPath = "C:\workspace\gate-dev\artifacts\workspace-installer-launch.log"
          if (Test-Path -LiteralPath $launchLogPath -PathType Leaf) {
            Copy-Item -LiteralPath $launchLogPath -Destination "C:\workspace\artifacts\windows-image-gate\workspace-installer-launch.log" -Force
          }
          if ([int]$installerProcess.ExitCode -ne 0) {
            throw "Installer failed with exit code $([int]$installerProcess.ExitCode)"
          }

          $installReportPath = "C:\workspace\gate-dev\artifacts\workspace-install-latest.json"
          if (-not (Test-Path -LiteralPath $installReportPath -PathType Leaf)) {
            throw "Installer report missing: $installReportPath"
          }
          $installReport = Get-Content -LiteralPath $installReportPath -Raw | ConvertFrom-Json -ErrorAction Stop
          if ([string]$installReport.status -ne "succeeded") {
            throw "Installer report status is not succeeded: $([string]$installReport.status)"
          }

          $selectedPplBitness = [string]$env:LVIE_GATE_SINGLE_PPL_BITNESS
          if ([string]::IsNullOrWhiteSpace($selectedPplBitness)) {
            $selectedPplBitness = '64'
          }
          if ($selectedPplBitness -notin @('32', '64')) {
            throw "Invalid LVIE_GATE_SINGLE_PPL_BITNESS value '$selectedPplBitness'. Expected '32' or '64'."
          }

          $ppl32 = [string]$installReport.ppl_capability_checks.'32'.status
          $ppl64 = [string]$installReport.ppl_capability_checks.'64'.status
          $pplStatusByBitness = @{
            '32' = $ppl32
            '64' = $ppl64
          }
          $selectedPplStatus = [string]$pplStatusByBitness[$selectedPplBitness]
          if ($selectedPplStatus -ne "pass") {
            throw "PPL $selectedPplBitness-bit gate did not pass. status=$selectedPplStatus"
          }

          $vipStatus = [string]$installReport.vip_package_build_check.status
          $vipPath = [string]$installReport.vip_package_build_check.output_vip_path
          if ($vipStatus -ne "pass") { throw "VIP gate did not pass. status=$vipStatus" }
          if ([string]::IsNullOrWhiteSpace($vipPath) -or -not (Test-Path -LiteralPath $vipPath -PathType Leaf)) {
            throw "VIP output missing after successful gate: $vipPath"
          }

          [ordered]@{
            status = "pass"
            install_report = $installReportPath
            selected_ppl_bitness = $selectedPplBitness
            selected_ppl_status = $selectedPplStatus
            ppl_32_status = $ppl32
            ppl_64_status = $ppl64
            vip_status = $vipStatus
            vip_output = $vipPath
            timestamp_utc = (Get-Date).ToUniversalTime().ToString("o")
          } | ConvertTo-Json -Depth 5 | Set-Content -LiteralPath "C:\workspace\artifacts\windows-image-gate\windows-image-gate-report.json" -Encoding utf8
          '@

          $labviewImage = [string]$env:LABVIEW_WINDOWS_IMAGE
          if ([string]::IsNullOrWhiteSpace($labviewImage)) {
            $labviewImage = 'nationalinstruments/labview:2026q1-windows'
          }
          $dockerIsolation = [string]$env:LABVIEW_WINDOWS_DOCKER_ISOLATION
          if ([string]::IsNullOrWhiteSpace($dockerIsolation)) {
            $dockerIsolation = 'process'
          }
          $gateRequiredLabviewYear = '${{ vars.LABVIEW_GATE_REQUIRED_LABVIEW_YEAR }}'
          if ([string]::IsNullOrWhiteSpace($gateRequiredLabviewYear)) {
            $imageYearMatch = [regex]::Match($labviewImage, '(\d{4})q\d+-windows')
            if ($imageYearMatch.Success) {
              $gateRequiredLabviewYear = [string]$imageYearMatch.Groups[1].Value
            }
          }
          if ([string]::IsNullOrWhiteSpace($gateRequiredLabviewYear)) {
            $gateRequiredLabviewYear = '2020'
          }
          $singlePplBitness = '${{ vars.LABVIEW_GATE_SINGLE_PPL_BITNESS }}'
          if ([string]::IsNullOrWhiteSpace($singlePplBitness)) {
            $singlePplBitness = '64'
          }
          $labviewX86NipkgInstallCmd = '${{ vars.LABVIEW_X86_NIPKG_INSTALL_CMD }}'
          if ([string]::IsNullOrWhiteSpace($labviewX86NipkgInstallCmd)) {
            $nipkgExe = '"C:\Program Files\National Instruments\NI Package Manager\nipkg.exe"'
            if ($gateRequiredLabviewYear -eq '2026') {
              $labviewX86NipkgInstallCmd = @(
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2026-x86/26.1/released --name ni-labview-2026-core-x86-en-2026-q1-released",
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2026-x86/26.1/released-critical --name ni-labview-2026-core-x86-en-2026-q1-released-critical",
                "$nipkgExe update",
                "$nipkgExe install --accept-eulas --yes --include-recommended ni-labview-2026-core-x86-en"
              ) -join ' && '
            } elseif ($gateRequiredLabviewYear -eq '2020') {
              $labviewX86NipkgInstallCmd = @(
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2020-x86/20.0/released --name ni-labview-2020-core-x86-en-2020-released",
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2020-x86/20.0/released-critical --name ni-labview-2020-core-x86-en-2020-released-critical",
                "$nipkgExe update",
                "$nipkgExe install --accept-eulas --yes --include-recommended ni-labview-2020-core-x86-en"
              ) -join ' && '
            } else {
              $labviewX86NipkgInstallCmd = ''
            }
          }

          $hostPwshRoot = 'C:\Program Files\PowerShell\7'
          $hostGitRoot = 'C:\Program Files\Git'
          $hostGhRoot = 'C:\Program Files\GitHub CLI'
          $hostGCliRoot = 'C:\Program Files\G-CLI'
          foreach ($hostToolRoot in @($hostPwshRoot, $hostGitRoot, $hostGhRoot, $hostGCliRoot)) {
            if (-not (Test-Path -LiteralPath $hostToolRoot -PathType Container)) {
              throw "Required host tool root is missing for container bind mount: $hostToolRoot"
            }
          }

          docker run --rm `
            --isolation=$dockerIsolation `
            --env "VIPM_COMMUNITY_EDITION=true" `
            --env "LVIE_GATE_REQUIRED_LABVIEW_YEAR=$gateRequiredLabviewYear" `
            --env "LVIE_GATE_SINGLE_PPL_BITNESS=$singlePplBitness" `
            --env "LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD=$labviewX86NipkgInstallCmd" `
            --mount "type=bind,source=${env:GITHUB_WORKSPACE},target=C:\workspace" `
            --mount "type=bind,source=$hostPwshRoot,target=C:\host-tools\PowerShell7,readonly" `
            --mount "type=bind,source=$hostGitRoot,target=C:\host-tools\Git,readonly" `
            --mount "type=bind,source=$hostGhRoot,target=C:\host-tools\GitHubCLI,readonly" `
            --mount "type=bind,source=$hostGCliRoot,target=C:\host-tools\G-CLI,readonly" `
            $labviewImage `
            powershell -NoProfile -Command $containerCmd
          if ($LASTEXITCODE -ne 0) {
            throw "Windows image gate failed."
          }

      - name: Capture gate metadata
        id: capture-gate-metadata
        if: always()
        shell: pwsh
        env:
          JOB_STATUS: ${{ job.status }}
        run: |
          $ErrorActionPreference = 'Stop'
          $reportPath = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate\windows-image-gate-report.json'
          $artifactName = "windows-labview-image-gate-$env:GITHUB_RUN_ID"
          $status = if ($env:JOB_STATUS -eq 'success') { 'pass' } else { 'fail' }

          if (Test-Path -LiteralPath $reportPath -PathType Leaf) {
            try {
              $report = Get-Content -LiteralPath $reportPath -Raw | ConvertFrom-Json -ErrorAction Stop
              if ([string]$report.status -eq 'pass') {
                $status = 'pass'
              }
            } catch {
              # Keep status from job conclusion.
            }
          }

          "gate_status=$status" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "gate_report_artifact_name=$artifactName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "gate_report_path=$reportPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Upload windows image gate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-labview-image-gate-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/windows-image-gate
          if-no-files-found: error
