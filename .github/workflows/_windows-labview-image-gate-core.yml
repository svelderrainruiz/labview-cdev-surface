name: _windows-labview-image-gate-core

on:
  workflow_call:
    outputs:
      gate_status:
        description: Pass/fail status for the Windows image gate.
        value: ${{ jobs.gate-summary.outputs.gate_status }}
      gate_report_artifact_name:
        description: Artifact name containing gate logs and reports.
        value: ${{ jobs.gate-summary.outputs.gate_report_artifact_name }}
      gate_report_path:
        description: Full path for the generated windows image gate report JSON.
        value: ${{ jobs.gate-summary.outputs.gate_report_path }}

permissions:
  contents: read

jobs:
  resolve-parity-context:
    name: Resolve Container Parity Context
    runs-on: ubuntu-latest
    outputs:
      lvcontainer_raw: ${{ steps.resolve.outputs.lvcontainer_raw }}
      lvcontainer_windows_tag: ${{ steps.resolve.outputs.lvcontainer_windows_tag }}
      lvcontainer_windows_image: ${{ steps.resolve.outputs.lvcontainer_windows_image }}
      lvcontainer_year: ${{ steps.resolve.outputs.lvcontainer_year }}
      selected_ppl_bitness: ${{ steps.resolve.outputs.selected_ppl_bitness }}
      build_spec_marker: ${{ steps.resolve.outputs.build_spec_marker }}
      release_required_year: ${{ steps.resolve.outputs.release_required_year }}
      icon_editor_source_url: ${{ steps.resolve.outputs.icon_editor_source_url }}
      icon_editor_pinned_sha: ${{ steps.resolve.outputs.icon_editor_pinned_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve lvcontainer context from pinned icon-editor commit
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          manifest_path="$GITHUB_WORKSPACE/workspace-governance.json"
          if [[ ! -f "$manifest_path" ]]; then
            echo "Manifest not found: $manifest_path" >&2
            exit 1
          fi

          repo_json="$(jq -c '.managed_repos[] | select(.repo_name=="labview-icon-editor")' "$manifest_path")"
          if [[ -z "$repo_json" ]]; then
            echo "workspace-governance.json does not define managed repo 'labview-icon-editor'." >&2
            exit 1
          fi

          icon_editor_source_url="$(echo "$repo_json" | jq -r '.required_remotes.origin // empty')"
          icon_editor_pinned_sha="$(echo "$repo_json" | jq -r '.pinned_sha // empty')"
          if [[ -z "$icon_editor_source_url" || -z "$icon_editor_pinned_sha" ]]; then
            echo "Missing origin URL or pinned SHA for managed repo 'labview-icon-editor'." >&2
            exit 1
          fi

          release_required_year="$(jq -r '.installer_contract.release_build_contract.required_year // .installer_contract.labview_gate.required_year // "2020"' "$manifest_path")"
          if [[ ! "$release_required_year" =~ ^[0-9]{4}$ ]]; then
            echo "Invalid release required year '$release_required_year' in installer contract." >&2
            exit 1
          fi

          selected_ppl_bitness='${{ vars.LABVIEW_GATE_SINGLE_PPL_BITNESS }}'
          if [[ -z "$selected_ppl_bitness" ]]; then
            selected_ppl_bitness='64'
          fi
          if [[ "$selected_ppl_bitness" != "32" && "$selected_ppl_bitness" != "64" ]]; then
            echo "Invalid LABVIEW_GATE_SINGLE_PPL_BITNESS '$selected_ppl_bitness'. Expected 32 or 64." >&2
            exit 1
          fi

          tmp_root="$(mktemp -d)"
          trap 'rm -rf "$tmp_root"' EXIT
          clone_root="$tmp_root/icon-editor"

          git clone --quiet --no-tags "$icon_editor_source_url" "$clone_root"
          git -C "$clone_root" checkout --quiet --detach "$icon_editor_pinned_sha"

          lvcontainer_path="$clone_root/.lvcontainer"
          if [[ ! -f "$lvcontainer_path" ]]; then
            echo ".lvcontainer was not found at pinned icon-editor commit '$icon_editor_pinned_sha'." >&2
            exit 1
          fi

          lvcontainer_raw="$(tr -d '\r\n' < "$lvcontainer_path")"
          if [[ -z "$lvcontainer_raw" ]]; then
            echo ".lvcontainer is empty at pinned icon-editor commit '$icon_editor_pinned_sha'." >&2
            exit 1
          fi

          if [[ "$lvcontainer_raw" =~ -windows$ ]]; then
            lvcontainer_windows_tag="$lvcontainer_raw"
          elif [[ "$lvcontainer_raw" =~ -linux$ ]]; then
            lvcontainer_windows_tag="${lvcontainer_raw%-linux}-windows"
          else
            echo "Unsupported .lvcontainer tag '$lvcontainer_raw'. Expected '*-linux' or '*-windows'." >&2
            exit 1
          fi

          if [[ ! "$lvcontainer_windows_tag" =~ ^(latest|[0-9]{4}q[0-9]+)-windows$ ]]; then
            echo "Resolved windows tag '$lvcontainer_windows_tag' is invalid." >&2
            exit 1
          fi

          mapfile -t allowed_windows_tags < <(jq -r '.installer_contract.container_parity_contract.allowed_windows_tags[]? // empty' "$manifest_path")
          if (( ${#allowed_windows_tags[@]} > 0 )); then
            tag_allowed='false'
            for allowed in "${allowed_windows_tags[@]}"; do
              if [[ "$allowed" == "$lvcontainer_windows_tag" ]]; then
                tag_allowed='true'
                break
              fi
            done
            if [[ "$tag_allowed" != 'true' ]]; then
              echo "Resolved windows tag '$lvcontainer_windows_tag' is not in allowed_windows_tags contract." >&2
              exit 1
            fi
          fi

          lvcontainer_year=''
          if [[ "$lvcontainer_windows_tag" =~ ^([0-9]{4})q[0-9]+-windows$ ]]; then
            lvcontainer_year="${BASH_REMATCH[1]}"
          fi
          if [[ -z "$lvcontainer_year" ]]; then
            echo "Unable to derive LabVIEW year from resolved windows tag '$lvcontainer_windows_tag'." >&2
            exit 1
          fi

          lvcontainer_windows_image="nationalinstruments/labview:${lvcontainer_windows_tag}"

          build_spec_kind="$(jq -r '.installer_contract.container_parity_contract.build_spec_kind // "ppl"' "$manifest_path")"
          build_spec_placeholder="$(jq -r '.installer_contract.container_parity_contract.build_spec_placeholder // "srcdist"' "$manifest_path")"
          build_spec_marker="${build_spec_kind}+${build_spec_placeholder}-placeholder"

          echo "lvcontainer_raw=$lvcontainer_raw" >> "$GITHUB_OUTPUT"
          echo "lvcontainer_windows_tag=$lvcontainer_windows_tag" >> "$GITHUB_OUTPUT"
          echo "lvcontainer_windows_image=$lvcontainer_windows_image" >> "$GITHUB_OUTPUT"
          echo "lvcontainer_year=$lvcontainer_year" >> "$GITHUB_OUTPUT"
          echo "selected_ppl_bitness=$selected_ppl_bitness" >> "$GITHUB_OUTPUT"
          echo "build_spec_marker=$build_spec_marker" >> "$GITHUB_OUTPUT"
          echo "release_required_year=$release_required_year" >> "$GITHUB_OUTPUT"
          echo "icon_editor_source_url=$icon_editor_source_url" >> "$GITHUB_OUTPUT"
          echo "icon_editor_pinned_sha=$icon_editor_pinned_sha" >> "$GITHUB_OUTPUT"

  windows-host-release-gate:
    name: Windows Host Release Gate (LabVIEW ${{ needs.resolve-parity-context.outputs.release_required_year }})
    needs: [resolve-parity-context]
    runs-on: [self-hosted, windows, self-hosted-windows-lv]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build installer payload for host-release gate
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $gateRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate\release'
          $payloadRoot = Join-Path $gateRoot 'payload'
          if (Test-Path -LiteralPath $gateRoot -PathType Container) {
            Remove-Item -LiteralPath $gateRoot -Recurse -Force
          }
          New-Item -Path $payloadRoot -ItemType Directory -Force | Out-Null

          $payloadContractRoot = Join-Path $env:GITHUB_WORKSPACE 'workspace-governance-payload'
          if (-not (Test-Path -LiteralPath $payloadContractRoot -PathType Container)) {
            throw "Canonical payload root not found: $payloadContractRoot"
          }
          Copy-Item -Path (Join-Path $payloadContractRoot '*') -Destination $payloadRoot -Recurse -Force

          New-Item -Path (Join-Path $payloadRoot 'scripts') -ItemType Directory -Force | Out-Null
          New-Item -Path (Join-Path $payloadRoot 'tools\runner-cli\win-x64') -ItemType Directory -Force | Out-Null
          Copy-Item -Path "$env:GITHUB_WORKSPACE/scripts/Install-WorkspaceFromManifest.ps1" -Destination (Join-Path $payloadRoot 'scripts/Install-WorkspaceFromManifest.ps1') -Force
          $resolveIsolationScript = Join-Path $env:GITHUB_WORKSPACE 'scripts/Resolve-IsolatedBuildWorkspace.ps1'
          $convertManifestScript = Join-Path $env:GITHUB_WORKSPACE 'scripts/Convert-ManifestToWorkspace.ps1'
          foreach ($requiredScriptPath in @($resolveIsolationScript, $convertManifestScript)) {
            if (-not (Test-Path -LiteralPath $requiredScriptPath -PathType Leaf)) {
              throw "Required isolation script is missing: $requiredScriptPath"
            }
          }
          $payloadManifestPath = Join-Path $payloadRoot 'workspace-governance/workspace-governance.json'
          $isolationReportPath = Join-Path $gateRoot 'isolated-workspace-resolution.json'
          $isolation = & $resolveIsolationScript `
            -PolicyManifestPath $payloadManifestPath `
            -WorkspaceKind 'windows-host-release-gate' `
            -OutputPath $isolationReportPath
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to resolve isolated workspace root for host release payload build.'
          }
          $isolatedWorkspaceRoot = [string]$isolation.workspace_root
          $isolatedReposRoot = [string]$isolation.repos_root
          $isolatedJobRoot = [string]$isolation.job_root
          if ([string]::IsNullOrWhiteSpace($isolatedWorkspaceRoot) -or [string]::IsNullOrWhiteSpace($isolatedReposRoot) -or [string]::IsNullOrWhiteSpace($isolatedJobRoot)) {
            throw 'Isolation resolver returned incomplete host release paths.'
          }
          @(
            "LVIE_ISOLATED_JOB_ROOT_RELEASE=$isolatedJobRoot",
            "LVIE_ISOLATED_WORKSPACE_ROOT_RELEASE=$isolatedWorkspaceRoot",
            "LVIE_ISOLATED_REPOS_ROOT_RELEASE=$isolatedReposRoot"
          ) | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          $pwshCmd = Get-Command 'pwsh' -ErrorAction SilentlyContinue
          if ($null -eq $pwshCmd -or [string]::IsNullOrWhiteSpace($pwshCmd.Source)) {
            throw 'PowerShell 7 (pwsh) is required on the host runner for payload bootstrap scripts.'
          }
          $pwshExe = $pwshCmd.Source

          & $pwshExe -NoProfile -ExecutionPolicy RemoteSigned -File "$env:GITHUB_WORKSPACE/scripts/Build-RunnerCliBundleFromManifest.ps1" `
            -ManifestPath (Join-Path $payloadRoot 'workspace-governance/workspace-governance.json') `
            -OutputRoot (Join-Path $payloadRoot 'tools/runner-cli/win-x64') `
            -RepoName 'labview-icon-editor' `
            -Runtime 'win-x64' `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to build runner-cli bundle for host release gate.'
          }

          $requiredLabviewYear = '${{ needs.resolve-parity-context.outputs.release_required_year }}'
          if ([string]::IsNullOrWhiteSpace($requiredLabviewYear)) {
            throw 'Resolved release required year is empty.'
          }
          if ($requiredLabviewYear -ne '2020') {
            throw "Host release contract requires LabVIEW 2020 only. resolved_year=$requiredLabviewYear"
          }

          & $convertManifestScript -ManifestPath $payloadManifestPath -WorkspaceRoot $isolatedWorkspaceRoot -OutputPath $payloadManifestPath | Out-Null
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to rewrite host release payload manifest for isolated workspace root '$isolatedWorkspaceRoot'."
          }

          $installerPath = Join-Path $gateRoot 'lvie-cdev-workspace-installer.exe'
          $nsisRoot = '${{ vars.NSIS_ROOT }}'
          if ([string]::IsNullOrWhiteSpace($nsisRoot)) { $nsisRoot = 'C:\Program Files (x86)\NSIS' }

          & $pwshExe -NoProfile -ExecutionPolicy RemoteSigned -File "$env:GITHUB_WORKSPACE/scripts/Build-WorkspaceBootstrapInstaller.ps1" `
            -PayloadRoot $payloadRoot `
            -OutputPath $installerPath `
            -WorkspaceRootDefault $isolatedWorkspaceRoot `
            -RequiredLabviewYear $requiredLabviewYear `
            -NsisRoot $nsisRoot `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to build installer for host release gate.'
          }

      - name: Run host release installer gate
        shell: powershell
        timeout-minutes: 120
        env:
          RELEASE_REQUIRED_YEAR: ${{ needs.resolve-parity-context.outputs.release_required_year }}
          SELECTED_PPL_BITNESS: ${{ needs.resolve-parity-context.outputs.selected_ppl_bitness }}
        run: |
          $ErrorActionPreference = 'Stop'
          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate\release'
          $installerPath = Join-Path $artifactRoot 'lvie-cdev-workspace-installer.exe'
          if (-not (Test-Path -LiteralPath $installerPath -PathType Leaf)) {
            throw "Installer missing for host release gate: $installerPath"
          }

          $manifestPath = Join-Path $artifactRoot 'payload\workspace-governance\workspace-governance.json'
          $sourceManifestPath = Join-Path $env:GITHUB_WORKSPACE 'workspace-governance.json'
          $prepareRepoScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Prepare-IsolatedRepoAtPinnedSha.ps1'
          foreach ($requiredScriptPath in @($prepareRepoScript)) {
            if (-not (Test-Path -LiteralPath $requiredScriptPath -PathType Leaf)) {
              throw "Required isolation script is missing: $requiredScriptPath"
            }
          }

          foreach ($requiredRoot in @(
            'C:\Program Files\National Instruments\LabVIEW 2020',
            'C:\Program Files (x86)\National Instruments\LabVIEW 2020',
            'C:\Program Files\Git',
            'C:\Program Files\GitHub CLI',
            'C:\Program Files\G-CLI'
          )) {
            if (-not (Test-Path -LiteralPath $requiredRoot -PathType Container)) {
              throw "Host release gate requires root path: $requiredRoot"
            }
          }
          if (-not (Test-Path -LiteralPath $manifestPath -PathType Leaf)) {
            throw "Workspace governance manifest is missing for host release gate: $manifestPath"
          }
          if (-not (Test-Path -LiteralPath $sourceManifestPath -PathType Leaf)) {
            throw "Source workspace governance manifest is missing: $sourceManifestPath"
          }

          $workspaceRoot = [string]$env:LVIE_ISOLATED_WORKSPACE_ROOT_RELEASE
          $reposRoot = [string]$env:LVIE_ISOLATED_REPOS_ROOT_RELEASE
          $jobRoot = [string]$env:LVIE_ISOLATED_JOB_ROOT_RELEASE
          if ([string]::IsNullOrWhiteSpace($workspaceRoot) -or [string]::IsNullOrWhiteSpace($reposRoot) -or [string]::IsNullOrWhiteSpace($jobRoot)) {
            throw 'Host release isolated workspace environment is incomplete. Ensure payload build step exported LVIE_ISOLATED_* variables.'
          }

          $sourceManifest = Get-Content -LiteralPath $sourceManifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $manifest = Get-Content -LiteralPath $manifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $sourceStatusPreRoot = Join-Path $artifactRoot 'source-status-pre'
          $sourceStatusPostRoot = Join-Path $artifactRoot 'source-status-post'
          $provisioningRoot = Join-Path $artifactRoot 'repo-provisioning'
          foreach ($path in @($sourceStatusPreRoot, $sourceStatusPostRoot, $provisioningRoot)) {
            if (-not (Test-Path -LiteralPath $path -PathType Container)) {
              New-Item -Path $path -ItemType Directory -Force | Out-Null
            }
          }

          $safeRepoPaths = @(
            @($manifest.managed_repos |
              ForEach-Object { [string]$_.path } |
              Where-Object { -not [string]::IsNullOrWhiteSpace($_) } |
              Select-Object -Unique)
          )
          foreach ($safeRepoPath in $safeRepoPaths) {
            & git config --global --add safe.directory $safeRepoPath 2>$null
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to configure git safe.directory entry for host release gate path: $safeRepoPath"
            }
          }
          foreach ($repo in @($manifest.managed_repos)) {
            $repoPath = [string]$repo.path
            $repoName = [string]$repo.repo_name
            $repoOriginUrl = [string]$repo.required_remotes.origin
            $repoDefaultBranch = [string]$repo.default_branch
            $repoPinnedSha = ([string]$repo.pinned_sha).ToLowerInvariant()
            $sourceRepoPath = ''
            $sourceEntry = @($sourceManifest.managed_repos | Where-Object { [string]$_.repo_name -eq $repoName }) | Select-Object -First 1
            if ($null -ne $sourceEntry) {
              $sourceRepoPath = [string]$sourceEntry.path
            }
            $sourceStatusPrePath = Join-Path $sourceStatusPreRoot ("{0}.status.txt" -f $repoName)
            $sourceStatusPostPath = Join-Path $sourceStatusPostRoot ("{0}.status.txt" -f $repoName)
            $provisionReportPath = Join-Path $provisioningRoot ("{0}.provision.json" -f $repoName)

            if ([string]::IsNullOrWhiteSpace($repoPath) -or [string]::IsNullOrWhiteSpace($repoPinnedSha)) {
              continue
            }

            if (-not [string]::IsNullOrWhiteSpace($sourceRepoPath) -and (Test-Path -LiteralPath $sourceRepoPath -PathType Container) -and (Test-Path -LiteralPath (Join-Path $sourceRepoPath '.git'))) {
              & git -C $sourceRepoPath status --porcelain | Set-Content -LiteralPath $sourceStatusPrePath -Encoding utf8
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to capture pre-provision source status for '$repoName' from '$sourceRepoPath'."
              }
            } else {
              Set-Content -LiteralPath $sourceStatusPrePath -Value 'source_repo_unavailable' -Encoding utf8
            }

            if ([string]::IsNullOrWhiteSpace($repoOriginUrl)) {
              throw "Managed repository '$repoName' is missing required_remotes.origin for isolated bootstrap."
            }

            $provisionResult = & $prepareRepoScript `
              -RepoName $repoName `
              -RepoOriginUrl $repoOriginUrl `
              -PinnedSha $repoPinnedSha `
              -DefaultBranch $repoDefaultBranch `
              -SourceRepoPath $sourceRepoPath `
              -TargetRepoPath $repoPath `
              -OutputPath $provisionReportPath
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to provision managed repository '$repoName' at '$repoPath'."
            }

            if (-not [string]::IsNullOrWhiteSpace($sourceRepoPath) -and (Test-Path -LiteralPath $sourceRepoPath -PathType Container) -and (Test-Path -LiteralPath (Join-Path $sourceRepoPath '.git'))) {
              & git -C $sourceRepoPath status --porcelain | Set-Content -LiteralPath $sourceStatusPostPath -Encoding utf8
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to capture post-provision source status for '$repoName' from '$sourceRepoPath'."
              }
            } else {
              Set-Content -LiteralPath $sourceStatusPostPath -Value 'source_repo_unavailable' -Encoding utf8
            }

            if (-not (Test-Path -LiteralPath (Join-Path $repoPath '.git') -PathType Container)) {
              throw "Provisioned isolated repository is not a git repository: $repoPath"
            }
          }

          if (-not (Test-Path -LiteralPath $workspaceRoot -PathType Container)) {
            New-Item -Path $workspaceRoot -ItemType Directory -Force | Out-Null
          }

          $env:VIPM_COMMUNITY_EDITION = 'true'
          $env:LVIE_OFFLINE_GIT_MODE = 'true'
          $env:LVIE_INSTALLER_EXECUTION_PROFILE = 'host-release'
          $env:LVIE_WORKTREE_ROOT = $reposRoot
          $env:LVIE_GATE_REQUIRED_LABVIEW_YEAR = [string]$env:RELEASE_REQUIRED_YEAR
          $env:LVIE_RUNNERCLI_EXECUTION_LABVIEW_YEAR = [string]$env:RELEASE_REQUIRED_YEAR
          $env:LVIE_GATE_SINGLE_PPL_BITNESS = [string]$env:SELECTED_PPL_BITNESS

          $installerProcess = Start-Process -FilePath $installerPath -ArgumentList '/S' -Wait -PassThru

          if (Test-Path -LiteralPath $launchLogPath -PathType Leaf) {
            Copy-Item -LiteralPath $launchLogPath -Destination (Join-Path $artifactRoot 'workspace-installer-launch.log') -Force
          }
          if (Test-Path -LiteralPath $installReportPath -PathType Leaf) {
            Copy-Item -LiteralPath $installReportPath -Destination (Join-Path $artifactRoot 'workspace-install-latest.json') -Force
          }

          if ([int]$installerProcess.ExitCode -ne 0) {
            throw "Host release installer failed with exit code $([int]$installerProcess.ExitCode)."
          }

          if (-not (Test-Path -LiteralPath $installReportPath -PathType Leaf)) {
            throw "Host release installer report missing: $installReportPath"
          }

          $installReport = Get-Content -LiteralPath $installReportPath -Raw | ConvertFrom-Json -ErrorAction Stop
          if ([string]$installReport.status -ne 'succeeded') {
            throw "Host release installer report status is not succeeded: $([string]$installReport.status)"
          }

          $selectedPplBitness = [string]$env:SELECTED_PPL_BITNESS
          if ([string]::IsNullOrWhiteSpace($selectedPplBitness)) { $selectedPplBitness = '64' }
          if ($selectedPplBitness -notin @('32', '64')) {
            throw "Invalid selected bitness '$selectedPplBitness'."
          }

          $selectedPplStatus = [string]$installReport.ppl_capability_checks.$selectedPplBitness.status
          if ($selectedPplStatus -ne 'pass') {
            throw "Host release PPL $selectedPplBitness-bit gate did not pass. status=$selectedPplStatus"
          }

          $vipStatus = [string]$installReport.vip_package_build_check.status
          $vipPath = [string]$installReport.vip_package_build_check.output_vip_path
          if ($vipStatus -ne 'pass') {
            throw "Host release VIP gate did not pass. status=$vipStatus"
          }
          if ([string]::IsNullOrWhiteSpace($vipPath) -or -not (Test-Path -LiteralPath $vipPath -PathType Leaf)) {
            throw "Host release VIP output missing after successful gate: $vipPath"
          }

          [ordered]@{
            status = 'pass'
            gate_lane = 'host-release'
            selected_ppl_bitness = $selectedPplBitness
            selected_ppl_status = $selectedPplStatus
            vip_status = $vipStatus
            vip_output = $vipPath
            report_path = $installReportPath
            execution_profile = [string]$installReport.execution_profile
            isolated_job_root = $jobRoot
            isolated_workspace_root = $workspaceRoot
            isolated_repos_root = $reposRoot
            timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
          } | ConvertTo-Json -Depth 8 | Set-Content -LiteralPath (Join-Path $artifactRoot 'windows-host-release-gate-report.json') -Encoding utf8

      - name: Upload host release gate artifacts (attempt 1)
        if: always()
        id: upload_host_release_artifacts_attempt_1
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: windows-labview-image-gate-release-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/windows-image-gate/release
          if-no-files-found: error
      - name: Upload host release gate artifacts (attempt 2)
        if: always() && steps.upload_host_release_artifacts_attempt_1.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: windows-labview-image-gate-release-${{ github.run_id }}
          path: ${{ github.workspace }}/artifacts/windows-image-gate/release
          if-no-files-found: error

      - name: Cleanup host release isolated workspace root
        if: always()
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $cleanupScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Cleanup-IsolatedBuildWorkspace.ps1'
          if (-not (Test-Path -LiteralPath $cleanupScript -PathType Leaf)) {
            throw "Cleanup script is missing: $cleanupScript"
          }

          $isolatedJobRoot = [string]$env:LVIE_ISOLATED_JOB_ROOT_RELEASE
          if ([string]::IsNullOrWhiteSpace($isolatedJobRoot)) {
            Write-Warning 'LVIE_ISOLATED_JOB_ROOT_RELEASE is empty; skipping cleanup.'
            exit 0
          }

          & $cleanupScript -Path $isolatedJobRoot -BestEffort | Out-Null

  windows-container-parity-gate:
    name: Windows Container Parity (${{ needs.resolve-parity-context.outputs.lvcontainer_raw }} | b${{ needs.resolve-parity-context.outputs.selected_ppl_bitness }} | ${{ needs.resolve-parity-context.outputs.build_spec_marker }})
    needs: [resolve-parity-context]
    runs-on: [self-hosted, windows, self-hosted-windows-lv, windows-containers, user-session, cdev-surface-windows-gate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build installer payload for container parity gate
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $gateRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate\parity'
          $payloadRoot = Join-Path $gateRoot 'payload'
          if (Test-Path -LiteralPath $gateRoot -PathType Container) {
            Remove-Item -LiteralPath $gateRoot -Recurse -Force
          }
          New-Item -Path $payloadRoot -ItemType Directory -Force | Out-Null

          $payloadContractRoot = Join-Path $env:GITHUB_WORKSPACE 'workspace-governance-payload'
          if (-not (Test-Path -LiteralPath $payloadContractRoot -PathType Container)) {
            throw "Canonical payload root not found: $payloadContractRoot"
          }
          Copy-Item -Path (Join-Path $payloadContractRoot '*') -Destination $payloadRoot -Recurse -Force

          New-Item -Path (Join-Path $payloadRoot 'scripts') -ItemType Directory -Force | Out-Null
          New-Item -Path (Join-Path $payloadRoot 'tools\runner-cli\win-x64') -ItemType Directory -Force | Out-Null
          Copy-Item -Path "$env:GITHUB_WORKSPACE/scripts/Install-WorkspaceFromManifest.ps1" -Destination (Join-Path $payloadRoot 'scripts/Install-WorkspaceFromManifest.ps1') -Force

          $pwshCmd = Get-Command 'pwsh' -ErrorAction SilentlyContinue
          if ($null -eq $pwshCmd -or [string]::IsNullOrWhiteSpace($pwshCmd.Source)) {
            throw 'PowerShell 7 (pwsh) is required on the host runner for payload bootstrap scripts.'
          }
          $pwshExe = $pwshCmd.Source

          & $pwshExe -NoProfile -ExecutionPolicy RemoteSigned -File "$env:GITHUB_WORKSPACE/scripts/Build-RunnerCliBundleFromManifest.ps1" `
            -ManifestPath (Join-Path $payloadRoot 'workspace-governance/workspace-governance.json') `
            -OutputRoot (Join-Path $payloadRoot 'tools/runner-cli/win-x64') `
            -RepoName 'labview-icon-editor' `
            -Runtime 'win-x64' `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to build runner-cli bundle for container parity gate.'
          }

          $requiredLabviewYear = '${{ needs.resolve-parity-context.outputs.lvcontainer_year }}'
          if ([string]::IsNullOrWhiteSpace($requiredLabviewYear)) {
            throw 'Resolved container parity LabVIEW year is empty.'
          }

          $installerPath = Join-Path $gateRoot 'lvie-cdev-workspace-installer.exe'
          $nsisRoot = '${{ vars.NSIS_ROOT }}'
          if ([string]::IsNullOrWhiteSpace($nsisRoot)) { $nsisRoot = 'C:\Program Files (x86)\NSIS' }

          & $pwshExe -NoProfile -ExecutionPolicy RemoteSigned -File "$env:GITHUB_WORKSPACE/scripts/Build-WorkspaceBootstrapInstaller.ps1" `
            -PayloadRoot $payloadRoot `
            -OutputPath $installerPath `
            -WorkspaceRootDefault 'C:\dev' `
            -RequiredLabviewYear $requiredLabviewYear `
            -NsisRoot $nsisRoot `
            -Deterministic:$true
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to build installer for container parity gate.'
          }

      - name: Validate Windows container engine and configure parity image/isolation
        shell: powershell
        env:
          DERIVED_WINDOWS_IMAGE: ${{ needs.resolve-parity-context.outputs.lvcontainer_windows_image }}
          DERIVED_WINDOWS_TAG: ${{ needs.resolve-parity-context.outputs.lvcontainer_windows_tag }}
          DERIVED_LVCONTAINER_RAW: ${{ needs.resolve-parity-context.outputs.lvcontainer_raw }}
        run: |
          $ErrorActionPreference = 'Stop'
          $derivedImage = [string]$env:DERIVED_WINDOWS_IMAGE
          $derivedTag = [string]$env:DERIVED_WINDOWS_TAG
          $lvcontainerRaw = [string]$env:DERIVED_LVCONTAINER_RAW

          if ([string]::IsNullOrWhiteSpace($derivedImage) -or [string]::IsNullOrWhiteSpace($derivedTag)) {
            throw 'Resolved parity image/tag is empty.'
          }

          $overrideImage = '${{ vars.LABVIEW_WINDOWS_IMAGE }}'
          if (-not [string]::IsNullOrWhiteSpace($overrideImage) -and ($overrideImage -ne $derivedImage)) {
            throw "LABVIEW_WINDOWS_IMAGE override '$overrideImage' does not match .lvcontainer-derived image '$derivedImage' (raw=$lvcontainerRaw)."
          }
          $labviewImage = if ([string]::IsNullOrWhiteSpace($overrideImage)) { $derivedImage } else { $overrideImage }

          $requestedIsolation = '${{ vars.LABVIEW_WINDOWS_DOCKER_ISOLATION }}'
          if ([string]::IsNullOrWhiteSpace($requestedIsolation)) {
            $requestedIsolation = 'auto'
          }
          $requestedIsolation = $requestedIsolation.Trim().ToLowerInvariant()
          if (@('auto', 'process', 'hyperv') -notcontains $requestedIsolation) {
            throw "Invalid LABVIEW_WINDOWS_DOCKER_ISOLATION value '$requestedIsolation'. Supported values: auto, process, hyperv."
          }

          $serverOs = (& docker version --format '{{.Server.Os}}' 2>$null).Trim().ToLowerInvariant()
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($serverOs)) {
            throw 'Failed to query Docker server OS. Ensure Docker Desktop is running and accessible from the runner service account.'
          }
          if ($serverOs -ne 'windows') {
            throw "Docker server OS is '$serverOs'. Runner must be preconfigured for Windows containers; automatic engine switching is disabled for non-interactive CI."
          }

          $hostKernelVersion = (& docker version --format '{{.Server.KernelVersion}}' 2>$null).Trim()
          if ([string]::IsNullOrWhiteSpace($hostKernelVersion)) {
            $hostKernelVersion = [System.Environment]::OSVersion.Version.ToString()
          }

          $manifestJson = (& docker manifest inspect --verbose $labviewImage 2>$null)
          if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace($manifestJson)) {
            throw "Failed to inspect Docker image manifest for '$labviewImage'."
          }

          $manifest = $manifestJson | ConvertFrom-Json -ErrorAction Stop
          $imageOsVersion = [string]$manifest.Descriptor.platform.'os.version'
          if ([string]::IsNullOrWhiteSpace($imageOsVersion)) {
            throw "Docker image '$labviewImage' does not expose Descriptor.platform.os.version; cannot validate host compatibility."
          }

          function Get-WindowsVersionPrefix {
            param([Parameter(Mandatory = $true)][string]$VersionString)
            if ($VersionString -match '(\d+\.\d+\.\d+)') {
              return $Matches[1]
            }
            return $VersionString
          }

          $hostVersionPrefix = Get-WindowsVersionPrefix -VersionString $hostKernelVersion
          $imageVersionPrefix = Get-WindowsVersionPrefix -VersionString $imageOsVersion

          $effectiveIsolation = 'process'
          if ($hostVersionPrefix -ne $imageVersionPrefix) {
            if ($requestedIsolation -eq 'process') {
              throw "Windows container compatibility mismatch. Host kernel '$hostKernelVersion' does not match image '$labviewImage' os.version '$imageOsVersion'. LABVIEW_WINDOWS_DOCKER_ISOLATION is explicitly set to process, so fallback is disabled."
            }
            $effectiveIsolation = 'hyperv'
            Write-Host "::warning::Windows container compatibility mismatch detected. Falling back to Hyper-V isolation for image '$labviewImage'. Host='$hostKernelVersion' Image='$imageOsVersion'."
          } elseif ($requestedIsolation -eq 'hyperv') {
            $effectiveIsolation = 'hyperv'
            Write-Host '::notice::LABVIEW_WINDOWS_DOCKER_ISOLATION requests Hyper-V isolation for compatible host/image versions.'
          }

          if ($effectiveIsolation -eq 'process') {
            docker pull $labviewImage
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to pull LabVIEW Windows image '$labviewImage'."
            }
          } else {
            Write-Host "Skipping explicit docker pull because effective isolation is '$effectiveIsolation'. The docker run step will resolve and pull image '$labviewImage' under Hyper-V isolation."
          }

          "LABVIEW_WINDOWS_IMAGE=$labviewImage" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "LABVIEW_WINDOWS_DOCKER_ISOLATION=$effectiveIsolation" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "LVIE_PARITY_LVCONTAINER_RAW=$lvcontainerRaw" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          "LVIE_PARITY_WINDOWS_TAG=$derivedTag" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

      - name: Run installer + project-spec parity + VI analyzer in Windows container
        shell: powershell
        timeout-minutes: 150
        env:
          PARITY_REQUIRED_YEAR: ${{ needs.resolve-parity-context.outputs.lvcontainer_year }}
          RELEASE_REQUIRED_YEAR: ${{ needs.resolve-parity-context.outputs.release_required_year }}
          SELECTED_PPL_BITNESS: ${{ needs.resolve-parity-context.outputs.selected_ppl_bitness }}
          PARITY_BUILD_SPEC_MARKER: ${{ needs.resolve-parity-context.outputs.build_spec_marker }}
          PARITY_CONTAINER_TIMEOUT_MINUTES: ${{ vars.LVIE_PARITY_CONTAINER_SCRIPT_TIMEOUT_MINUTES }}
          PARITY_INSTALLER_TIMEOUT_MINUTES: ${{ vars.LVIE_PARITY_INSTALLER_TIMEOUT_MINUTES }}
          PARITY_VI_ANALYZER_TIMEOUT_MINUTES: ${{ vars.LVIE_PARITY_VI_ANALYZER_TIMEOUT_MINUTES }}
          PARITY_POSTPHASE_COPY_TIMEOUT_SECONDS: ${{ vars.LVIE_PARITY_POSTPHASE_COPY_TIMEOUT_SECONDS }}
          PARITY_LABVIEW_X86_NIPKG_INSTALL_CMD: ${{ vars.LABVIEW_X86_NIPKG_INSTALL_CMD }}
          PARITY_DOCKER_DNS: ${{ vars.LABVIEW_WINDOWS_DOCKER_DNS }}
        run: |
          $ErrorActionPreference = 'Stop'

          $artifactRoot = Join-Path $env:GITHUB_WORKSPACE 'artifacts\windows-image-gate\parity'
          $installerPath = Join-Path $artifactRoot 'lvie-cdev-workspace-installer.exe'
          if (-not (Test-Path -LiteralPath $installerPath -PathType Leaf)) {
            throw "Installer missing for parity gate: $installerPath"
          }

          $containerCmd = @'
          $ErrorActionPreference = "Stop"

          $env:Path = @(
            'C:\host-tools\PowerShell7',
            'C:\host-tools\Git\cmd',
            'C:\host-tools\GitHubCLI',
            'C:\host-tools\G-CLI\bin',
            $env:Path
          ) -join ';'

          $env:VIPM_COMMUNITY_EDITION = 'true'
          $env:LVIE_OFFLINE_GIT_MODE = 'true'
          $env:LVIE_INSTALLER_EXECUTION_PROFILE = 'container-parity'
          $env:LVIE_WORKTREE_ROOT = 'C:\dev'
          $env:LVIE_GATE_REQUIRED_LABVIEW_YEAR = [string]$env:LVIE_GATE_REQUIRED_LABVIEW_YEAR
          $env:LVIE_RUNNERCLI_EXECUTION_LABVIEW_YEAR = [string]$env:LVIE_RUNNERCLI_EXECUTION_LABVIEW_YEAR
          $env:LVIE_GATE_SINGLE_PPL_BITNESS = [string]$env:LVIE_GATE_SINGLE_PPL_BITNESS
          $labviewX86NipkgInstallCmdB64 = [string]$env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD_B64
          if (-not [string]::IsNullOrWhiteSpace($labviewX86NipkgInstallCmdB64)) {
            try {
              $env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($labviewX86NipkgInstallCmdB64))
            } catch {
              throw "LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD_B64 is not valid base64. $($_.Exception.Message)"
            }
          } else {
            $env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD = [string]$env:LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD
          }
          $env:LVIE_PARITY_LVCONTAINER_RAW = [string]$env:LVIE_PARITY_LVCONTAINER_RAW
          $env:LVIE_PARITY_WINDOWS_TAG = [string]$env:LVIE_PARITY_WINDOWS_TAG
          $env:LVIE_PARITY_BUILD_SPEC_KIND = 'ppl'
          $env:LVIE_PARITY_BUILD_SPEC_PLACEHOLDER = 'srcdist'

          $artifactRoot = "C:\workspace\artifacts\windows-image-gate\parity"
          if (-not (Test-Path -LiteralPath $artifactRoot -PathType Container)) {
            New-Item -Path $artifactRoot -ItemType Directory -Force | Out-Null
          }
          $phaseCheckpointsPath = Join-Path $artifactRoot 'phase-checkpoints.log'
          if (Test-Path -LiteralPath $phaseCheckpointsPath -PathType Leaf) {
            Remove-Item -LiteralPath $phaseCheckpointsPath -Force
          }

          function Write-PhaseCheckpoint {
            param(
              [Parameter(Mandatory = $true)][string]$Phase,
              [Parameter()][string]$Status = 'info',
              [Parameter()][string]$Message = ''
            )

            $entry = [ordered]@{
              timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
              phase = $Phase
              status = $Status
              message = $Message
            } | ConvertTo-Json -Compress
            Add-Content -LiteralPath $phaseCheckpointsPath -Value $entry -Encoding utf8
            Write-Host "phase=$Phase status=$Status message=$Message"
          }

          function Get-PositiveIntOrDefault {
            param(
              [Parameter()][string]$RawValue,
              [Parameter(Mandatory = $true)][int]$DefaultValue
            )

            $parsed = 0
            if ([int]::TryParse([string]$RawValue, [ref]$parsed) -and $parsed -gt 0) {
              return $parsed
            }
            return $DefaultValue
          }

          function Copy-FileWithTimeout {
            param(
              [Parameter(Mandatory = $true)][string]$SourcePath,
              [Parameter(Mandatory = $true)][string]$DestinationPath,
              [Parameter(Mandatory = $true)][int]$TimeoutSeconds
            )

            $copyJob = Start-Job -ScriptBlock {
              param($src, $dst)
              if (Test-Path -LiteralPath $src -PathType Leaf) {
                Copy-Item -LiteralPath $src -Destination $dst -Force
              }
            } -ArgumentList $SourcePath, $DestinationPath
            try {
              $completed = Wait-Job -Id $copyJob.Id -Timeout $TimeoutSeconds
              if ($null -eq $completed) {
                throw "postphase_copy_timeout: timeout_seconds=$TimeoutSeconds source=$SourcePath"
              }
              Receive-Job -Id $copyJob.Id | Out-Null
            } finally {
              Remove-Job -Id $copyJob.Id -Force -ErrorAction SilentlyContinue | Out-Null
            }
          }

          $installerTimeoutMinutes = Get-PositiveIntOrDefault -RawValue ([string]$env:LVIE_PARITY_INSTALLER_TIMEOUT_MINUTES) -DefaultValue 90
          $viAnalyzerTimeoutMinutes = Get-PositiveIntOrDefault -RawValue ([string]$env:LVIE_PARITY_VI_ANALYZER_TIMEOUT_MINUTES) -DefaultValue 45
          $postphaseCopyTimeoutSeconds = Get-PositiveIntOrDefault -RawValue ([string]$env:LVIE_PARITY_POSTPHASE_COPY_TIMEOUT_SECONDS) -DefaultValue 300

          $requiredCommands = @('powershell', 'git', 'gh', 'g-cli')
          $missingCommands = @()
          foreach ($name in $requiredCommands) {
            if (-not (Get-Command $name -ErrorAction SilentlyContinue)) {
              $missingCommands += $name
            }
          }
          if ($missingCommands.Count -gt 0) {
            throw "Container runtime missing required commands after host-tool mount: $($missingCommands -join ', ')"
          }

          $manifestPath = "C:\workspace\artifacts\windows-image-gate\parity\payload\workspace-governance\workspace-governance.json"
          if (-not (Test-Path -LiteralPath $manifestPath -PathType Leaf)) {
            throw "Workspace governance manifest is missing for container parity gate: $manifestPath"
          }
          $manifest = Get-Content -LiteralPath $manifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $safeRepoPaths = @(
            @($manifest.managed_repos |
              ForEach-Object { [string]$_.path } |
              Where-Object { -not [string]::IsNullOrWhiteSpace($_) } |
              Select-Object -Unique)
          )
          foreach ($safeRepoPath in $safeRepoPaths) {
            & git config --global --add safe.directory $safeRepoPath 2>$null
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to configure git safe.directory entry for container parity gate path: $safeRepoPath"
            }
          }

          Write-PhaseCheckpoint -Phase 'installer_start' -Status 'info' -Message "timeout_minutes=$installerTimeoutMinutes"
          $installerProcess = Start-Process -FilePath "C:\workspace\artifacts\windows-image-gate\parity\lvie-cdev-workspace-installer.exe" -ArgumentList '/S' -PassThru
          $installerExited = $installerProcess.WaitForExit($installerTimeoutMinutes * 60 * 1000)
          if (-not $installerExited) {
            try {
              $installerProcess.Kill()
            } catch {}
            Write-PhaseCheckpoint -Phase 'installer_timeout' -Status 'fail' -Message "timeout_minutes=$installerTimeoutMinutes"
            throw "installer_timeout: workspace installer exceeded timeout_minutes=$installerTimeoutMinutes."
          }
          Write-PhaseCheckpoint -Phase 'installer_done' -Status 'info' -Message "exit_code=$([int]$installerProcess.ExitCode)"

          $workspaceRoot = 'C:\dev'
          $workspaceArtifactsRoot = Join-Path $workspaceRoot 'artifacts'
          $launchLogPath = Join-Path $workspaceArtifactsRoot 'workspace-installer-launch.log'
          $installReportPath = Join-Path $workspaceArtifactsRoot 'workspace-install-latest.json'

          Write-PhaseCheckpoint -Phase 'postphase_copy_start' -Status 'info' -Message "timeout_seconds=$postphaseCopyTimeoutSeconds"
          if (Test-Path -LiteralPath $launchLogPath -PathType Leaf) {
            Copy-FileWithTimeout -SourcePath $launchLogPath -Destination "C:\workspace\artifacts\windows-image-gate\parity\workspace-installer-launch.log" -TimeoutSeconds $postphaseCopyTimeoutSeconds
          }
          if (Test-Path -LiteralPath $installReportPath -PathType Leaf) {
            Copy-FileWithTimeout -SourcePath $installReportPath -Destination "C:\workspace\artifacts\windows-image-gate\parity\workspace-install-latest.json" -TimeoutSeconds $postphaseCopyTimeoutSeconds
          }
          Write-PhaseCheckpoint -Phase 'postphase_copy_done' -Status 'info' -Message 'installer logs copied'

          if ([int]$installerProcess.ExitCode -ne 0) {
            throw "Installer failed with exit code $([int]$installerProcess.ExitCode)."
          }
          if (-not (Test-Path -LiteralPath $installReportPath -PathType Leaf)) {
            throw "Installer report missing: $installReportPath"
          }

          $installReport = Get-Content -LiteralPath $installReportPath -Raw | ConvertFrom-Json -ErrorAction Stop
          if ([string]$installReport.status -ne 'succeeded') {
            throw "Installer report status is not succeeded: $([string]$installReport.status)"
          }

          $selectedPplBitness = [string]$env:LVIE_GATE_SINGLE_PPL_BITNESS
          if ([string]::IsNullOrWhiteSpace($selectedPplBitness)) {
            $selectedPplBitness = '64'
          }
          if ($selectedPplBitness -notin @('32', '64')) {
            throw "Invalid LVIE_GATE_SINGLE_PPL_BITNESS value '$selectedPplBitness'. Expected '32' or '64'."
          }

          $selectedPplStatus = [string]$installReport.ppl_capability_checks.$selectedPplBitness.status
          if ($selectedPplStatus -ne 'pass') {
            throw "PPL $selectedPplBitness-bit parity gate did not pass. status=$selectedPplStatus"
          }

          $vipStatus = [string]$installReport.vip_package_build_check.status
          if ($vipStatus -ne 'skipped') {
            throw "Container parity profile must skip VIP build. observed_status=$vipStatus"
          }

          $iconEditorRoot = 'C:\dev\labview-icon-editor'
          $viAnalyzerScript = Join-Path $iconEditorRoot 'Tooling\container-parity\run-vi-analyzer-windows.ps1'
          if (-not (Test-Path -LiteralPath $viAnalyzerScript -PathType Leaf)) {
            throw "Container parity VI Analyzer script missing: $viAnalyzerScript"
          }

          $viAnalyzerStatusPath = 'builds\status\vi-analyzer-summary.parity.windows.gate.json'
          $viAnalyzerReportsRoot = 'builds\vi-analyzer\windows-container-gate'
          $viAnalyzerArgs = @(
            '-NoLogo',
            '-NoProfile',
            '-NonInteractive',
            '-ExecutionPolicy', 'Bypass',
            '-File', $viAnalyzerScript,
            '-WorkspaceRoot', $iconEditorRoot,
            '-LabVIEWVersion', ([string]$env:PARITY_REQUIRED_YEAR),
            '-LabVIEWBitness', $selectedPplBitness,
            '-ReportsRoot', $viAnalyzerReportsRoot,
            '-StatusPath', $viAnalyzerStatusPath
          )
          Write-PhaseCheckpoint -Phase 'vi_analyzer_start' -Status 'info' -Message "timeout_minutes=$viAnalyzerTimeoutMinutes"
          $viAnalyzerProcess = Start-Process -FilePath 'powershell' -ArgumentList $viAnalyzerArgs -PassThru
          $viAnalyzerExited = $viAnalyzerProcess.WaitForExit($viAnalyzerTimeoutMinutes * 60 * 1000)
          if (-not $viAnalyzerExited) {
            try {
              $viAnalyzerProcess.Kill()
            } catch {}
            Write-PhaseCheckpoint -Phase 'vi_analyzer_timeout' -Status 'fail' -Message "timeout_minutes=$viAnalyzerTimeoutMinutes"
            throw "vi_analyzer_timeout: VI Analyzer exceeded timeout_minutes=$viAnalyzerTimeoutMinutes."
          }
          if ([int]$viAnalyzerProcess.ExitCode -ne 0) {
            throw "Container parity VI Analyzer failed with exit code $([int]$viAnalyzerProcess.ExitCode)."
          }
          Write-PhaseCheckpoint -Phase 'vi_analyzer_done' -Status 'info' -Message "exit_code=$([int]$viAnalyzerProcess.ExitCode)"

          $resolvedViAnalyzerStatusPath = Join-Path $iconEditorRoot $viAnalyzerStatusPath
          if (-not (Test-Path -LiteralPath $resolvedViAnalyzerStatusPath -PathType Leaf)) {
            throw "Container parity VI Analyzer status file missing: $resolvedViAnalyzerStatusPath"
          }
          Copy-FileWithTimeout -SourcePath $resolvedViAnalyzerStatusPath -Destination "C:\workspace\artifacts\windows-image-gate\parity\vi-analyzer-summary.parity.windows.gate.json" -TimeoutSeconds $postphaseCopyTimeoutSeconds
          Write-PhaseCheckpoint -Phase 'finalize_done' -Status 'pass' -Message 'parity report and VI Analyzer status persisted'

          [ordered]@{
            status = 'pass'
            gate_lane = 'container-parity'
            lvcontainer_raw = [string]$env:LVIE_PARITY_LVCONTAINER_RAW
            lvcontainer_windows_tag = [string]$env:LVIE_PARITY_WINDOWS_TAG
            selected_ppl_bitness = $selectedPplBitness
            selected_ppl_status = $selectedPplStatus
            vip_status = $vipStatus
            vi_analyzer_status_path = $resolvedViAnalyzerStatusPath
            build_spec_marker = [string]$env:PARITY_BUILD_SPEC_MARKER
            install_report_path = $installReportPath
            timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
          } | ConvertTo-Json -Depth 10 | Set-Content -LiteralPath "C:\workspace\artifacts\windows-image-gate\parity\windows-container-parity-gate-report.json" -Encoding utf8
          '@
          $containerCmdEncoded = [Convert]::ToBase64String([Text.Encoding]::Unicode.GetBytes($containerCmd))

          $labviewImage = [string]$env:LABVIEW_WINDOWS_IMAGE
          if ([string]::IsNullOrWhiteSpace($labviewImage)) {
            throw 'LABVIEW_WINDOWS_IMAGE is not set for parity gate.'
          }

          $dockerIsolation = [string]$env:LABVIEW_WINDOWS_DOCKER_ISOLATION
          if ([string]::IsNullOrWhiteSpace($dockerIsolation)) {
            $dockerIsolation = 'process'
          }

          $requiredYear = [string]$env:RELEASE_REQUIRED_YEAR
          if ([string]::IsNullOrWhiteSpace($requiredYear)) {
            throw 'RELEASE_REQUIRED_YEAR is empty.'
          }
          $parityExecutionYear = [string]$env:PARITY_REQUIRED_YEAR
          if ([string]::IsNullOrWhiteSpace($parityExecutionYear)) {
            throw 'PARITY_REQUIRED_YEAR is empty.'
          }

          $singlePplBitness = [string]$env:SELECTED_PPL_BITNESS
          if ([string]::IsNullOrWhiteSpace($singlePplBitness)) {
            $singlePplBitness = '64'
          }

          $containerScriptTimeoutMinutes = 140
          $installerTimeoutMinutes = 90
          $viAnalyzerTimeoutMinutes = 45
          $postphaseCopyTimeoutSeconds = 300
          [int]::TryParse([string]$env:PARITY_CONTAINER_TIMEOUT_MINUTES, [ref]$containerScriptTimeoutMinutes) | Out-Null
          [int]::TryParse([string]$env:PARITY_INSTALLER_TIMEOUT_MINUTES, [ref]$installerTimeoutMinutes) | Out-Null
          [int]::TryParse([string]$env:PARITY_VI_ANALYZER_TIMEOUT_MINUTES, [ref]$viAnalyzerTimeoutMinutes) | Out-Null
          [int]::TryParse([string]$env:PARITY_POSTPHASE_COPY_TIMEOUT_SECONDS, [ref]$postphaseCopyTimeoutSeconds) | Out-Null
          if ($containerScriptTimeoutMinutes -lt 30) { $containerScriptTimeoutMinutes = 30 }
          if ($installerTimeoutMinutes -lt 5) { $installerTimeoutMinutes = 5 }
          if ($viAnalyzerTimeoutMinutes -lt 5) { $viAnalyzerTimeoutMinutes = 5 }
          if ($postphaseCopyTimeoutSeconds -lt 30) { $postphaseCopyTimeoutSeconds = 30 }

          $labviewX86NipkgInstallCmd = [string]$env:PARITY_LABVIEW_X86_NIPKG_INSTALL_CMD
          if ([string]::IsNullOrWhiteSpace($labviewX86NipkgInstallCmd)) {
            $nipkgExe = '"C:\Program Files\National Instruments\NI Package Manager\nipkg.exe"'
            if ($parityExecutionYear -eq '2026') {
              $labviewX86NipkgInstallCmd = @(
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2026-x86/26.1/released --name=ni-labview-2026-core-x86-en-2026-q1-released",
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2026-x86/26.1/released-critical --name=ni-labview-2026-core-x86-en-2026-q1-released-critical",
                "$nipkgExe update",
                "$nipkgExe install --accept-eulas --yes --include-recommended ni-labview-2026-core-x86-en"
              ) -join ' && '
            } elseif ($parityExecutionYear -eq '2020') {
              $labviewX86NipkgInstallCmd = @(
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2020-x86/20.0/released --name=ni-labview-2020-core-x86-en-2020-released",
                "$nipkgExe feed-add https://download.ni.com/support/nipkg/products/ni-l/ni-labview-2020-x86/20.0/released-critical --name=ni-labview-2020-core-x86-en-2020-released-critical",
                "$nipkgExe update",
                "$nipkgExe install --accept-eulas --yes --include-recommended ni-labview-2020-core-x86-en"
              ) -join ' && '
            } else {
              $labviewX86NipkgInstallCmd = ''
            }
          }
          $labviewX86NipkgInstallCmdB64 = ''
          if (-not [string]::IsNullOrWhiteSpace($labviewX86NipkgInstallCmd)) {
            $labviewX86NipkgInstallCmdB64 = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($labviewX86NipkgInstallCmd))
          }

          $prepareRepoScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Prepare-IsolatedRepoAtPinnedSha.ps1'
          $resolveIsolationScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Resolve-IsolatedBuildWorkspace.ps1'
          $convertManifestScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Convert-ManifestToWorkspace.ps1'
          foreach ($requiredScriptPath in @($prepareRepoScript, $resolveIsolationScript, $convertManifestScript)) {
            if (-not (Test-Path -LiteralPath $requiredScriptPath -PathType Leaf)) {
              throw "Required isolation script is missing: $requiredScriptPath"
            }
          }

          $manifestPathCanonical = Join-Path $artifactRoot 'payload\workspace-governance\workspace-governance.json'
          if (-not (Test-Path -LiteralPath $manifestPathCanonical -PathType Leaf)) {
            throw "Workspace governance manifest is missing for container parity host preflight: $manifestPathCanonical"
          }
          $sourceManifest = Get-Content -LiteralPath $manifestPathCanonical -Raw | ConvertFrom-Json -ErrorAction Stop
          $isolationReportPath = Join-Path $artifactRoot 'isolated-workspace-resolution.json'
          $isolation = & $resolveIsolationScript `
            -PolicyManifestPath $manifestPathCanonical `
            -WorkspaceKind 'windows-container-parity-host-preflight' `
            -OutputPath $isolationReportPath
          if ($LASTEXITCODE -ne 0) {
            throw 'Failed to resolve isolated workspace root for container parity host preflight.'
          }

          $hostDevRoot = [string]$isolation.workspace_root
          $hostReposRoot = [string]$isolation.repos_root
          $isolatedJobRoot = [string]$isolation.job_root
          if ([string]::IsNullOrWhiteSpace($hostDevRoot) -or [string]::IsNullOrWhiteSpace($hostReposRoot) -or [string]::IsNullOrWhiteSpace($isolatedJobRoot)) {
            throw 'Isolation resolver returned incomplete host parity workspace paths.'
          }
          "LVIE_ISOLATED_JOB_ROOT_PARITY=$isolatedJobRoot" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

          $hostLabview2020x64Root = 'C:\Program Files\National Instruments\LabVIEW 2020'
          $hostLabview2020x86Root = 'C:\Program Files (x86)\National Instruments\LabVIEW 2020'
          $hostPwshRoot = 'C:\Program Files\PowerShell\7'
          $hostGitRoot = 'C:\Program Files\Git'
          $hostGhRoot = 'C:\Program Files\GitHub CLI'
          $hostGCliRoot = 'C:\Program Files\G-CLI'
          foreach ($hostToolRoot in @($hostLabview2020x64Root, $hostLabview2020x86Root, $hostGitRoot, $hostGhRoot, $hostGCliRoot)) {
            if (-not (Test-Path -LiteralPath $hostToolRoot -PathType Container)) {
              throw "Required host tool root is missing for container bind mount: $hostToolRoot"
            }
          }
          if (-not (Test-Path -LiteralPath $hostDevRoot -PathType Container)) {
            New-Item -Path $hostDevRoot -ItemType Directory -Force | Out-Null
          }
          $hasHostPwshRoot = Test-Path -LiteralPath $hostPwshRoot -PathType Container
          if (-not $hasHostPwshRoot) {
            Write-Warning "Host PowerShell 7 root is not present at '$hostPwshRoot'. Continuing with Windows PowerShell-first container surface."
          }

          $hostPreflightManifestPath = Join-Path $artifactRoot 'payload\workspace-governance\workspace-governance.host-preflight.json'
          & $convertManifestScript -ManifestPath $manifestPathCanonical -WorkspaceRoot $hostDevRoot -OutputPath $hostPreflightManifestPath | Out-Null
          if ($LASTEXITCODE -ne 0) {
            throw "Failed to rewrite container parity host preflight manifest for isolated root '$hostDevRoot'."
          }
          $manifest = Get-Content -LiteralPath $hostPreflightManifestPath -Raw | ConvertFrom-Json -ErrorAction Stop
          $sourceStatusPreRoot = Join-Path $artifactRoot 'source-status-pre'
          $sourceStatusPostRoot = Join-Path $artifactRoot 'source-status-post'
          $provisioningRoot = Join-Path $artifactRoot 'repo-provisioning'
          foreach ($path in @($sourceStatusPreRoot, $sourceStatusPostRoot, $provisioningRoot)) {
            if (-not (Test-Path -LiteralPath $path -PathType Container)) {
              New-Item -Path $path -ItemType Directory -Force | Out-Null
            }
          }

          $safeRepoPaths = @(
            @($manifest.managed_repos |
              ForEach-Object { [string]$_.path } |
              Where-Object { -not [string]::IsNullOrWhiteSpace($_) } |
              Select-Object -Unique)
          )
          foreach ($safeRepoPath in $safeRepoPaths) {
            & git config --global --add safe.directory $safeRepoPath 2>$null
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to configure git safe.directory entry for container parity host preflight path: $safeRepoPath"
            }
          }
          foreach ($repo in @($manifest.managed_repos)) {
            $repoPath = [string]$repo.path
            $repoName = [string]$repo.repo_name
            $repoOriginUrl = [string]$repo.required_remotes.origin
            $repoDefaultBranch = [string]$repo.default_branch
            $repoPinnedSha = ([string]$repo.pinned_sha).ToLowerInvariant()
            $sourceRepoPath = ''
            $sourceEntry = @($sourceManifest.managed_repos | Where-Object { [string]$_.repo_name -eq $repoName }) | Select-Object -First 1
            if ($null -ne $sourceEntry) {
              $sourceRepoPath = [string]$sourceEntry.path
            }
            $sourceStatusPrePath = Join-Path $sourceStatusPreRoot ("{0}.status.txt" -f $repoName)
            $sourceStatusPostPath = Join-Path $sourceStatusPostRoot ("{0}.status.txt" -f $repoName)
            $provisionReportPath = Join-Path $provisioningRoot ("{0}.provision.json" -f $repoName)

            if ([string]::IsNullOrWhiteSpace($repoPath) -or [string]::IsNullOrWhiteSpace($repoPinnedSha)) {
              continue
            }

            if (-not [string]::IsNullOrWhiteSpace($sourceRepoPath) -and (Test-Path -LiteralPath $sourceRepoPath -PathType Container) -and (Test-Path -LiteralPath (Join-Path $sourceRepoPath '.git'))) {
              & git -C $sourceRepoPath status --porcelain | Set-Content -LiteralPath $sourceStatusPrePath -Encoding utf8
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to capture pre-provision source status for '$repoName' from '$sourceRepoPath'."
              }
            } else {
              Set-Content -LiteralPath $sourceStatusPrePath -Value 'source_repo_unavailable' -Encoding utf8
            }

            if ([string]::IsNullOrWhiteSpace($repoOriginUrl)) {
              throw "Managed repository '$repoName' is missing required_remotes.origin for isolated bootstrap."
            }

            & $prepareRepoScript `
              -RepoName $repoName `
              -RepoOriginUrl $repoOriginUrl `
              -PinnedSha $repoPinnedSha `
              -DefaultBranch $repoDefaultBranch `
              -SourceRepoPath $sourceRepoPath `
              -TargetRepoPath $repoPath `
              -OutputPath $provisionReportPath | Out-Null
            if ($LASTEXITCODE -ne 0) {
              throw "Failed to provision managed repository '$repoName' at '$repoPath'."
            }

            if (-not [string]::IsNullOrWhiteSpace($sourceRepoPath) -and (Test-Path -LiteralPath $sourceRepoPath -PathType Container) -and (Test-Path -LiteralPath (Join-Path $sourceRepoPath '.git'))) {
              & git -C $sourceRepoPath status --porcelain | Set-Content -LiteralPath $sourceStatusPostPath -Encoding utf8
              if ($LASTEXITCODE -ne 0) {
                throw "Failed to capture post-provision source status for '$repoName' from '$sourceRepoPath'."
              }
            } else {
              Set-Content -LiteralPath $sourceStatusPostPath -Value 'source_repo_unavailable' -Encoding utf8
            }

            if (-not (Test-Path -LiteralPath (Join-Path $repoPath '.git') -PathType Container)) {
              throw "Provisioned isolated repository is not a git repository: $repoPath"
            }
          }

          $hostMountRoot = Join-Path $artifactRoot 'host-mounts'
          if (Test-Path -LiteralPath $hostMountRoot -PathType Container) {
            Remove-Item -LiteralPath $hostMountRoot -Recurse -Force
          }
          New-Item -Path $hostMountRoot -ItemType Directory -Force | Out-Null

          $hostGitMountSource = Join-Path $hostMountRoot 'Git'
          $hostGhMountSource = Join-Path $hostMountRoot 'GitHubCLI'
          $hostGCliMountSource = Join-Path $hostMountRoot 'G-CLI'
          $hostPwshMountSource = Join-Path $hostMountRoot 'PowerShell7'
          foreach ($junction in @(
            @{ path = $hostGitMountSource; target = $hostGitRoot },
            @{ path = $hostGhMountSource; target = $hostGhRoot },
            @{ path = $hostGCliMountSource; target = $hostGCliRoot }
          )) {
            if (Test-Path -LiteralPath $junction.path) {
              Remove-Item -LiteralPath $junction.path -Force
            }
            New-Item -Path $junction.path -ItemType Junction -Target $junction.target -Force | Out-Null
          }
          if ($hasHostPwshRoot) {
            if (Test-Path -LiteralPath $hostPwshMountSource) {
              Remove-Item -LiteralPath $hostPwshMountSource -Force
            }
            New-Item -Path $hostPwshMountSource -ItemType Junction -Target $hostPwshRoot -Force | Out-Null
          }

          $containerName = "lvie-gate-$env:GITHUB_RUN_ID-$env:GITHUB_RUN_ATTEMPT"
          $containerName = $containerName.ToLowerInvariant()
          $dockerDnsRaw = [string]$env:PARITY_DOCKER_DNS
          if ([string]::IsNullOrWhiteSpace($dockerDnsRaw)) {
            $dockerDnsRaw = '8.8.8.8'
          }
          $dockerDnsServers = @($dockerDnsRaw.Split(',') | ForEach-Object { $_.Trim() } | Where-Object { -not [string]::IsNullOrWhiteSpace($_) })
          if ($dockerDnsServers.Count -eq 0) {
            $dockerDnsServers = @('8.8.8.8')
          }
          $dnsIpv4Pattern = '^(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(?:\.(?:25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}$'
          foreach ($dnsServer in $dockerDnsServers) {
            if ($dnsServer -notmatch $dnsIpv4Pattern) {
              throw "Invalid LABVIEW_WINDOWS_DOCKER_DNS value '$dnsServer'. Expected comma-separated IPv4 addresses."
            }
          }
          $dockerArgs = @(
            'run',
            '--name', $containerName,
            "--isolation=$dockerIsolation"
          )
          foreach ($dnsServer in $dockerDnsServers) {
            $dockerArgs += @('--dns', $dnsServer)
          }
          $dockerArgs += @(
            '--env', 'VIPM_COMMUNITY_EDITION=true',
            '--env', 'LVIE_OFFLINE_GIT_MODE=true',
            '--env', "LVIE_GATE_REQUIRED_LABVIEW_YEAR=$requiredYear",
            '--env', "LVIE_RUNNERCLI_EXECUTION_LABVIEW_YEAR=$parityExecutionYear",
            '--env', "LVIE_GATE_SINGLE_PPL_BITNESS=$singlePplBitness",
            '--env', "LVIE_LABVIEW_X86_NIPKG_INSTALL_CMD_B64=$labviewX86NipkgInstallCmdB64",
            '--env', "PARITY_REQUIRED_YEAR=$parityExecutionYear",
            '--env', "LVIE_PARITY_LVCONTAINER_RAW=$env:LVIE_PARITY_LVCONTAINER_RAW",
            '--env', "LVIE_PARITY_WINDOWS_TAG=$env:LVIE_PARITY_WINDOWS_TAG",
            '--env', "PARITY_BUILD_SPEC_MARKER=$env:PARITY_BUILD_SPEC_MARKER",
            '--env', "LVIE_PARITY_INSTALLER_TIMEOUT_MINUTES=$installerTimeoutMinutes",
            '--env', "LVIE_PARITY_VI_ANALYZER_TIMEOUT_MINUTES=$viAnalyzerTimeoutMinutes",
            '--env', "LVIE_PARITY_POSTPHASE_COPY_TIMEOUT_SECONDS=$postphaseCopyTimeoutSeconds"
          )
          $dockerMountSpecs = @(
            "type=bind,source=$($env:GITHUB_WORKSPACE),target=C:\workspace",
            "type=bind,source=$hostDevRoot,target=C:\dev",
            "type=bind,source=$hostGitMountSource,target=C:\host-tools\Git,readonly",
            "type=bind,source=$hostGhMountSource,target=C:\host-tools\GitHubCLI,readonly",
            "type=bind,source=$hostGCliMountSource,target=C:\host-tools\G-CLI,readonly"
          )
          if ($hasHostPwshRoot) {
            $dockerMountSpecs += "type=bind,source=$hostPwshMountSource,target=C:\host-tools\PowerShell7,readonly"
          }
          foreach ($dockerMountSpec in $dockerMountSpecs) {
            $dockerArgs += @('--mount', $dockerMountSpec)
          }
          $dockerArgs += @(
            $labviewImage,
            'powershell', '-NoProfile', '-EncodedCommand', $containerCmdEncoded
          )

          $dockerStdoutPath = Join-Path $artifactRoot 'docker-run-stdout.log'
          $dockerStderrPath = Join-Path $artifactRoot 'docker-run-stderr.log'
          if (Test-Path -LiteralPath $dockerStdoutPath -PathType Leaf) { Remove-Item -LiteralPath $dockerStdoutPath -Force }
          if (Test-Path -LiteralPath $dockerStderrPath -PathType Leaf) { Remove-Item -LiteralPath $dockerStderrPath -Force }

          $dockerProcess = $null
          $containerScriptNonExit = $false
          $heartbeatIntervalSeconds = 60
          $heartbeatPollSeconds = 15
          $lastHeartbeatUtc = [DateTime]::MinValue
          $deadlineUtc = (Get-Date).ToUniversalTime().AddMinutes($containerScriptTimeoutMinutes)

          try {
            $dockerProcess = Start-Process -FilePath 'docker' -ArgumentList $dockerArgs -PassThru -RedirectStandardOutput $dockerStdoutPath -RedirectStandardError $dockerStderrPath

            while (-not $dockerProcess.HasExited) {
              Start-Sleep -Seconds $heartbeatPollSeconds
              $dockerProcess.Refresh()
              $nowUtc = (Get-Date).ToUniversalTime()

              if ($nowUtc -ge $deadlineUtc) {
                $containerScriptNonExit = $true
                Write-Warning "container_script_non_exit: docker run exceeded timeout_minutes=$containerScriptTimeoutMinutes."
                try {
                  Stop-Process -Id $dockerProcess.Id -Force
                } catch {
                  Write-Warning "Failed to stop docker process id=$($dockerProcess.Id). $($_.Exception.Message)"
                }
                break
              }

              if (($nowUtc - $lastHeartbeatUtc).TotalSeconds -ge $heartbeatIntervalSeconds) {
                $elapsedSeconds = [int](($nowUtc - $dockerProcess.StartTime.ToUniversalTime()).TotalSeconds)
                $state = (& docker inspect --format '{{.State.Status}}|{{.State.Running}}|{{.State.StartedAt}}' $containerName 2>$null)
                if ($LASTEXITCODE -ne 0 -or [string]::IsNullOrWhiteSpace([string]$state)) {
                  $state = 'container_not_visible'
                }
                Write-Host "::notice::windows_container_parity_heartbeat elapsed_seconds=$elapsedSeconds timeout_minutes=$containerScriptTimeoutMinutes state=$state image=$labviewImage isolation=$dockerIsolation"

                $phasePath = Join-Path $artifactRoot 'phase-checkpoints.log'
                if (Test-Path -LiteralPath $phasePath -PathType Leaf) {
                  $recentPhases = Get-Content -LiteralPath $phasePath -Tail 3
                  foreach ($phaseEntry in @($recentPhases)) {
                    Write-Host "::notice::phase_checkpoint $phaseEntry"
                  }
                }
                $lastHeartbeatUtc = $nowUtc
              }
            }

            if ($null -ne $dockerProcess -and -not $dockerProcess.HasExited) {
              try {
                Wait-Process -Id $dockerProcess.Id -Timeout 30
              } catch {}
            }

            $dockerExitCode = if ($containerScriptNonExit) { 124 } else { [int]$dockerProcess.ExitCode }
            $containerLogsPath = Join-Path $artifactRoot 'container-console.log'
            if (Test-Path -LiteralPath $dockerStdoutPath -PathType Leaf) {
              Get-Content -LiteralPath $dockerStdoutPath | Set-Content -LiteralPath $containerLogsPath -Encoding utf8
            } else {
              Set-Content -LiteralPath $containerLogsPath -Value '' -Encoding utf8
            }
            if (Test-Path -LiteralPath $dockerStderrPath -PathType Leaf) {
              Add-Content -LiteralPath $containerLogsPath -Value ''
              Add-Content -LiteralPath $containerLogsPath -Value '--- stderr ---'
              Get-Content -LiteralPath $dockerStderrPath | Add-Content -LiteralPath $containerLogsPath -Encoding utf8
            }

            $phasePath = Join-Path $artifactRoot 'phase-checkpoints.log'
            $failureReason = if ($containerScriptNonExit) { 'container_script_non_exit' } else { 'container_boot_failure' }
            if (Test-Path -LiteralPath $phasePath -PathType Leaf) {
              $phaseContent = Get-Content -LiteralPath $phasePath -Raw
              foreach ($signature in @('installer_timeout', 'vi_analyzer_timeout', 'postphase_copy_timeout', 'container_script_non_exit')) {
                if ($phaseContent -match $signature) {
                  $failureReason = $signature
                  break
                }
              }
            }

            $classificationPath = Join-Path $artifactRoot 'container-execution-classification.json'
            [ordered]@{
              status = if ($dockerExitCode -eq 0) { 'pass' } else { 'fail' }
              reason = if ($dockerExitCode -eq 0) { 'none' } else { $failureReason }
              docker_exit_code = $dockerExitCode
              docker_timeout_minutes = $containerScriptTimeoutMinutes
              installer_timeout_minutes = $installerTimeoutMinutes
              vi_analyzer_timeout_minutes = $viAnalyzerTimeoutMinutes
              postphase_copy_timeout_seconds = $postphaseCopyTimeoutSeconds
              docker_isolation = $dockerIsolation
              docker_image = $labviewImage
              lvcontainer_raw = [string]$env:LVIE_PARITY_LVCONTAINER_RAW
              lvcontainer_windows_tag = [string]$env:LVIE_PARITY_WINDOWS_TAG
              selected_ppl_bitness = $singlePplBitness
              phase_checkpoints_path = $phasePath
              timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
            } | ConvertTo-Json -Depth 10 | Set-Content -LiteralPath $classificationPath -Encoding utf8

            if ($dockerExitCode -ne 0) {
              Write-Warning "Container parity gate failed. Collecting host fallback diagnostics."
              $fallbackDiagnostics = [ordered]@{
                status = 'fail'
                reason = $failureReason
                docker_exit_code = $dockerExitCode
                docker_isolation = $dockerIsolation
                docker_image = $labviewImage
                docker_dns_servers = @($dockerDnsServers)
                lvcontainer_raw = [string]$env:LVIE_PARITY_LVCONTAINER_RAW
                lvcontainer_windows_tag = [string]$env:LVIE_PARITY_WINDOWS_TAG
                selected_ppl_bitness = $singlePplBitness
                phase_checkpoints_path = $phasePath
                classification_path = $classificationPath
                timestamp_utc = (Get-Date).ToUniversalTime().ToString('o')
                host_probe = [ordered]@{
                  host_dev_root_exists = (Test-Path -LiteralPath $hostDevRoot -PathType Container)
                  host_labview_2020_x64_exists = (Test-Path -LiteralPath $hostLabview2020x64Root -PathType Container)
                  host_labview_2020_x86_exists = (Test-Path -LiteralPath $hostLabview2020x86Root -PathType Container)
                  host_powershell7_exists = $hasHostPwshRoot
                  host_git_exists = (Test-Path -LiteralPath $hostGitRoot -PathType Container)
                  host_gh_exists = (Test-Path -LiteralPath $hostGhRoot -PathType Container)
                  host_gcli_exists = (Test-Path -LiteralPath $hostGCliRoot -PathType Container)
                }
              }

              try {
                $fallbackDiagnostics.docker_version = (& docker version 2>&1 | Out-String).Trim()
              } catch {
                $fallbackDiagnostics.docker_version = "failed: $($_.Exception.Message)"
              }

              $fallbackPath = Join-Path $artifactRoot 'container-fallback-diagnostics.json'
              $fallbackDiagnostics | ConvertTo-Json -Depth 10 | Set-Content -LiteralPath $fallbackPath -Encoding utf8

              throw "Windows container parity gate failed with exit code $dockerExitCode. reason=$failureReason"
            }
          } finally {
            try {
              & docker rm -f $containerName *> $null
              $null = $LASTEXITCODE
            } catch {
              Write-Warning "Failed to remove container '$containerName'. $($_.Exception.Message)"
            }
          }

      - name: Upload container parity gate artifacts (attempt 1)
        if: always()
        id: upload_container_parity_artifacts_attempt_1
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: windows-labview-image-gate-parity-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/artifacts/windows-image-gate/parity
            !${{ github.workspace }}/artifacts/windows-image-gate/parity/host-mounts/**
          if-no-files-found: error
      - name: Upload container parity gate artifacts (attempt 2)
        if: always() && steps.upload_container_parity_artifacts_attempt_1.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: windows-labview-image-gate-parity-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/artifacts/windows-image-gate/parity
            !${{ github.workspace }}/artifacts/windows-image-gate/parity/host-mounts/**
          if-no-files-found: error

      - name: Cleanup container parity isolated workspace root
        if: always()
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $cleanupScript = Join-Path $env:GITHUB_WORKSPACE 'scripts\Cleanup-IsolatedBuildWorkspace.ps1'
          if (-not (Test-Path -LiteralPath $cleanupScript -PathType Leaf)) {
            throw "Cleanup script is missing: $cleanupScript"
          }

          $isolatedJobRoot = [string]$env:LVIE_ISOLATED_JOB_ROOT_PARITY
          if ([string]::IsNullOrWhiteSpace($isolatedJobRoot)) {
            Write-Warning 'LVIE_ISOLATED_JOB_ROOT_PARITY is empty; skipping cleanup.'
            exit 0
          }

          & $cleanupScript -Path $isolatedJobRoot -BestEffort | Out-Null

  gate-summary:
    name: Windows Gate Summary
    if: always()
    needs: [windows-host-release-gate, windows-container-parity-gate]
    runs-on: ubuntu-latest
    outputs:
      gate_status: ${{ steps.evaluate.outputs.gate_status }}
      gate_report_artifact_name: ${{ steps.evaluate.outputs.gate_report_artifact_name }}
      gate_report_path: ${{ steps.evaluate.outputs.gate_report_path }}
    steps:
      - id: evaluate
        shell: bash
        run: |
          set -euo pipefail

          host_result='${{ needs.windows-host-release-gate.result }}'
          parity_result='${{ needs.windows-container-parity-gate.result }}'

          gate_status='fail'
          if [[ "$host_result" == 'success' && "$parity_result" == 'success' ]]; then
            gate_status='pass'
          fi

          echo "gate_status=$gate_status" >> "$GITHUB_OUTPUT"
          echo "gate_report_artifact_name=windows-labview-image-gate-parity-${GITHUB_RUN_ID}" >> "$GITHUB_OUTPUT"
          echo "gate_report_path=${GITHUB_WORKSPACE}/artifacts/windows-image-gate/parity/windows-container-parity-gate-report.json" >> "$GITHUB_OUTPUT"

          {
            echo "## Windows Gate Summary"
            echo ""
            echo "- Host release gate: $host_result"
            echo "- Container parity gate: $parity_result"
            echo "- Overall status: $gate_status"
          } >> "$GITHUB_STEP_SUMMARY"

          if [[ "$gate_status" != 'pass' ]]; then
            echo "One or more hard gate lanes failed." >&2
            exit 1
          fi
