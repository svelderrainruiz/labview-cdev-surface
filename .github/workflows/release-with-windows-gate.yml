name: release-with-windows-gate

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish (for example, v0.1.0).
        required: true
        type: string
      allow_existing_tag:
        description: Allow updating an existing release tag (break-glass only).
        required: false
        default: false
        type: boolean
      prerelease:
        description: Publish as prerelease.
        required: false
        default: false
        type: boolean
      allow_gate_override:
        description: Allow publish when a hard gate fails (controlled break-glass).
        required: false
        default: false
        type: boolean
      override_reason:
        description: Required when allow_gate_override=true. Brief reason for override.
        required: false
        default: ''
        type: string
      override_incident_url:
        description: Required when allow_gate_override=true. GitHub issue/discussion URL.
        required: false
        default: ''
        type: string

permissions:
  contents: write

concurrency:
  group: release-with-gate-${{ inputs.release_tag }}
  cancel-in-progress: false

jobs:
  repo_guard:
    name: Repo Guard
    runs-on: ubuntu-latest
    steps:
      - name: Validate repository context
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $expectedRepo = 'LabVIEW-Community-CI-CD/labview-cdev-surface'
          $actualRepo = '${{ github.repository }}'
          if ($actualRepo -ne $expectedRepo) {
            throw "Release orchestration is restricted to '$expectedRepo'. Current repository '$actualRepo' is not allowed."
          }

  windows_gate:
    name: Windows Gate
    needs: [repo_guard]
    uses: ./.github/workflows/_windows-labview-image-gate-core.yml
    secrets: inherit

  linux_parity_gate:
    name: Linux Parity Gate
    needs: [repo_guard, windows_gate]
    uses: ./.github/workflows/_linux-labview-image-gate-core.yml
    with:
      windows_prereq_x86_artifact_name: ${{ needs.windows_gate.outputs.linux_prereq_x86_artifact_name }}
      windows_prereq_x64_artifact_name: ${{ needs.windows_gate.outputs.linux_prereq_x64_artifact_name }}
      windows_prereq_native_labview_version: ${{ needs.windows_gate.outputs.linux_prereq_native_labview_version }}
    secrets: inherit

  gate_policy:
    name: Gate Policy
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [repo_guard, windows_gate, linux_parity_gate]
    outputs:
      override_applied: ${{ steps.evaluate.outputs.override_applied }}
      override_reason: ${{ steps.evaluate.outputs.override_reason }}
      override_incident_url: ${{ steps.evaluate.outputs.override_incident_url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: evaluate
        name: Enforce hard gates, artifact policy, and controlled override
        shell: pwsh
        env:
          REPO_GUARD_RESULT: ${{ needs.repo_guard.result }}
          WINDOWS_GATE_RESULT: ${{ needs.windows_gate.result }}
          LINUX_GATE_RESULT: ${{ needs.linux_parity_gate.result }}
          ALLOW_GATE_OVERRIDE: ${{ inputs.allow_gate_override }}
          OVERRIDE_REASON_INPUT: ${{ inputs.override_reason }}
          OVERRIDE_INCIDENT_URL_INPUT: ${{ inputs.override_incident_url }}
        run: |
          $ErrorActionPreference = 'Stop'

          $repoGuardResult = [string]$env:REPO_GUARD_RESULT
          $windowsGateResult = [string]$env:WINDOWS_GATE_RESULT
          $linuxGateResult = [string]$env:LINUX_GATE_RESULT
          $allowOverride = [System.Convert]::ToBoolean([string]$env:ALLOW_GATE_OVERRIDE)
          $overrideReason = [string]$env:OVERRIDE_REASON_INPUT
          $overrideIncidentUrl = [string]$env:OVERRIDE_INCIDENT_URL_INPUT

          $overrideApplied = $false
          if ($repoGuardResult -ne 'success') {
            throw "Repository guard did not succeed. Blocking release publish."
          }
          $releaseCoreWorkflowPath = Join-Path $env:GITHUB_WORKSPACE '.github/workflows/_release-workspace-installer-core.yml'
          if (-not (Test-Path -LiteralPath $releaseCoreWorkflowPath -PathType Leaf)) {
            throw "Release core workflow missing: $releaseCoreWorkflowPath"
          }
          $releaseCoreWorkflowContent = Get-Content -LiteralPath $releaseCoreWorkflowPath -Raw
          if ($releaseCoreWorkflowContent -match 'artifacts/parity/linux/') {
            throw 'Release artifact policy violation. Parity artifacts under artifacts/parity/linux/* are non-promotable and cannot be consumed by release publish.'
          }

          $failedGates = @()
          if ($windowsGateResult -ne 'success') {
            $failedGates += 'windows_gate'
          }
          if ($linuxGateResult -ne 'success') {
            $failedGates += 'linux_parity_gate'
          }

          if ($failedGates.Count -eq 0) {
            Write-Host 'Windows and Linux parity gates passed. Release publish is allowed.'
          } else {
            if (-not $allowOverride) {
              throw "Gate failed and override is not enabled. Blocking release publish. failed_gates=$($failedGates -join ',')"
            }

            if ([string]::IsNullOrWhiteSpace($overrideReason)) {
              throw "allow_gate_override=true requires non-empty override_reason."
            }

            if ($overrideIncidentUrl -notmatch '^https://github\.com/[^/]+/[^/]+/(issues|discussions)/[0-9]+(?:[?#].*)?$') {
              throw "allow_gate_override=true requires override_incident_url to be a GitHub issue/discussion URL."
            }

            $overrideApplied = $true
            Write-Host "::warning::Gate failure override is active for failed_gates=$($failedGates -join ','). Reason: $overrideReason. Incident: $overrideIncidentUrl"

            @(
              "## Controlled Override Applied"
              ""
              "- Failed gates: $($failedGates -join ', ')"
              "- Reason: $overrideReason"
              "- Incident: $overrideIncidentUrl"
            ) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

          "override_applied=$($overrideApplied.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "override_reason=$overrideReason" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "override_incident_url=$overrideIncidentUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  release_publish:
    name: Release Publish
    needs: [gate_policy]
    uses: ./.github/workflows/_release-workspace-installer-core.yml
    with:
      release_tag: ${{ inputs.release_tag }}
      allow_existing_tag: ${{ inputs.allow_existing_tag }}
      prerelease: ${{ inputs.prerelease }}
      override_applied: ${{ fromJSON(needs.gate_policy.outputs.override_applied) }}
      override_reason: ${{ needs.gate_policy.outputs.override_reason }}
      override_incident_url: ${{ needs.gate_policy.outputs.override_incident_url }}
    secrets: inherit
