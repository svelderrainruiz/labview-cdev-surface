name: release-with-linux-gate

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: Release tag to publish (for example, v0.1.0).
        required: true
        type: string
      allow_existing_tag:
        description: Allow updating an existing release tag (break-glass only).
        required: false
        default: false
        type: boolean
      prerelease:
        description: Publish as prerelease.
        required: false
        default: false
        type: boolean
      allow_gate_override:
        description: Allow publish even if Linux gate fails (controlled break-glass).
        required: false
        default: false
        type: boolean
      override_reason:
        description: Required when allow_gate_override=true. Brief reason for override.
        required: false
        default: ''
        type: string
      override_incident_url:
        description: Required when allow_gate_override=true. GitHub issue/discussion URL.
        required: false
        default: ''
        type: string

permissions:
  contents: write

concurrency:
  group: release-with-gate-${{ inputs.release_tag }}
  cancel-in-progress: false

jobs:
  repo_guard:
    name: Repo Guard
    runs-on: ubuntu-latest
    steps:
      - name: Validate repository context
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $expectedRepo = 'LabVIEW-Community-CI-CD/labview-cdev-surface'
          $actualRepo = '${{ github.repository }}'
          if ($actualRepo -ne $expectedRepo) {
            throw "Release orchestration is restricted to '$expectedRepo'. Current repository '$actualRepo' is not allowed."
          }

  hosted_nsis_preflight:
    name: Hosted NSIS Preflight
    needs: [repo_guard]
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install pinned NSIS toolchain
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          choco install nsis --version=3.10 -y --no-progress
          $nsisRoot = 'C:\Program Files (x86)\NSIS'
          $makensisPath = Join-Path $nsisRoot 'makensis.exe'
          if (-not (Test-Path -LiteralPath $makensisPath -PathType Leaf)) {
            throw "makensis.exe was not found after NSIS install: $makensisPath"
          }
          $reportedVersion = (& $makensisPath /VERSION 2>&1 | Out-String).Trim()
          if ([string]::IsNullOrWhiteSpace($reportedVersion)) {
            throw 'NSIS preflight failed to read makensis version output.'
          }
          if ($reportedVersion -notmatch '^v?3\.10(\.|$)') {
            throw "Unexpected makensis version '$reportedVersion'. Expected NSIS 3.10.x."
          }

      - name: Validate NSIS installer script presence
        shell: powershell
        run: |
          $ErrorActionPreference = 'Stop'
          $installerScriptPath = Join-Path $env:GITHUB_WORKSPACE 'nsis\workspace-bootstrap-installer.nsi'
          if (-not (Test-Path -LiteralPath $installerScriptPath -PathType Leaf)) {
            throw "Installer script missing for preflight: $installerScriptPath"
          }

  linux_gate:
    name: Linux Gate
    needs: [repo_guard, hosted_nsis_preflight]
    uses: ./.github/workflows/_linux-labview-image-gate-core.yml
    secrets: inherit

  gate_policy:
    name: Gate Policy
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [repo_guard, hosted_nsis_preflight, linux_gate]
    outputs:
      override_applied: ${{ steps.evaluate.outputs.override_applied }}
      override_reason: ${{ steps.evaluate.outputs.override_reason }}
      override_incident_url: ${{ steps.evaluate.outputs.override_incident_url }}
    steps:
      - id: evaluate
        name: Enforce hard gate and controlled override
        shell: pwsh
        env:
          REPO_GUARD_RESULT: ${{ needs.repo_guard.result }}
          HOSTED_NSIS_PREFLIGHT_RESULT: ${{ needs.hosted_nsis_preflight.result }}
          LINUX_GATE_RESULT: ${{ needs.linux_gate.result }}
          ALLOW_GATE_OVERRIDE: ${{ inputs.allow_gate_override }}
          OVERRIDE_REASON_INPUT: ${{ inputs.override_reason }}
          OVERRIDE_INCIDENT_URL_INPUT: ${{ inputs.override_incident_url }}
        run: |
          $ErrorActionPreference = 'Stop'

          $repoGuardResult = [string]$env:REPO_GUARD_RESULT
          $hostedNsisPreflightResult = [string]$env:HOSTED_NSIS_PREFLIGHT_RESULT
          $linuxGateResult = [string]$env:LINUX_GATE_RESULT
          $allowOverride = [System.Convert]::ToBoolean([string]$env:ALLOW_GATE_OVERRIDE)
          $overrideReason = [string]$env:OVERRIDE_REASON_INPUT
          $overrideIncidentUrl = [string]$env:OVERRIDE_INCIDENT_URL_INPUT

          $overrideApplied = $false
          if ($repoGuardResult -ne 'success') {
            throw "Repository guard did not succeed. Blocking release publish."
          }
          if ($hostedNsisPreflightResult -ne 'success') {
            throw "Hosted NSIS preflight did not succeed. Blocking release publish."
          }
          if ($linuxGateResult -eq 'success') {
            Write-Host 'Linux gate passed. Release publish is allowed.'
          } else {
            if (-not $allowOverride) {
              throw "Linux gate failed and override is not enabled. Blocking release publish."
            }

            if ([string]::IsNullOrWhiteSpace($overrideReason)) {
              throw "allow_gate_override=true requires non-empty override_reason."
            }

            if ($overrideIncidentUrl -notmatch '^https://github\.com/[^/]+/[^/]+/(issues|discussions)/[0-9]+(?:[?#].*)?$') {
              throw "allow_gate_override=true requires override_incident_url to be a GitHub issue/discussion URL."
            }

            $overrideApplied = $true
            Write-Host "::warning::Linux gate failed but controlled override is active. linux_gate=$linuxGateResult Reason: $overrideReason. Incident: $overrideIncidentUrl"

            @(
              "## Controlled Override Applied"
              ""
              "- Linux gate result: $linuxGateResult"
              "- Reason: $overrideReason"
              "- Incident: $overrideIncidentUrl"
            ) | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Append -Encoding utf8
          }

          "override_applied=$($overrideApplied.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "override_reason=$overrideReason" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "override_incident_url=$overrideIncidentUrl" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

  release_publish:
    name: Release Publish
    needs: [gate_policy]
    uses: ./.github/workflows/_release-workspace-installer-core.yml
    with:
      release_tag: ${{ inputs.release_tag }}
      allow_existing_tag: ${{ inputs.allow_existing_tag }}
      prerelease: ${{ inputs.prerelease }}
      override_applied: ${{ fromJSON(needs.gate_policy.outputs.override_applied) }}
      override_reason: ${{ needs.gate_policy.outputs.override_reason }}
      override_incident_url: ${{ needs.gate_policy.outputs.override_incident_url }}
    secrets: inherit
